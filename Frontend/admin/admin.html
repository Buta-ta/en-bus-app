<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - En-Bus</title>
    <!-- On va utiliser le style.css principal, mais il faut corriger le chemin -->
    <link rel="stylesheet" href="../style.css"> 
    <style>
        /* Styles sp√©cifiques √† la page admin */
        body { background-color: var(--color-background); color: var(--color-text-primary); }
        .admin-container { max-width: 1600px; margin: 40px auto; padding: 0 20px; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header-bar h1 { margin: 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: 25px; text-align: center; }
        .stat-value { font-size: 42px; font-weight: bold; color: var(--color-accent-glow); }
        .stat-label { font-size: 14px; color: var(--color-text-secondary); text-transform: uppercase; margin-top: 8px; }
        
        /* Filtres */
        .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-input { flex-grow: 1; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid var(--color-border); border-radius: var(--radius-base); color: white; }
        .filter-btn { padding: 10px 20px; cursor: pointer; border: 1px solid var(--color-border); background: var(--color-surface); color: var(--color-text-secondary); border-radius: var(--radius-base); transition: all 0.2s; }
        .filter-btn.active { background: var(--color-accent-glow); color: var(--color-background); border-color: var(--color-accent-glow); font-weight: bold; }
        
        /* Tableau */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: var(--color-surface); border-radius: var(--radius-lg); overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--color-border); white-space: nowrap; }
        th { background: rgba(var(--color-accent-glow-rgb), 0.1); font-weight: 600; text-transform: uppercase; font-size: 12px; }
        
        /* Actions */
        .actions-cell button { margin-right: 8px; }
        .btn-small { padding: 6px 12px; font-size: 12px; }
        .btn-confirm { background-color: #4caf50; color: white; border: none; }
        .btn-cancel { background-color: #f44336; color: white; border: none; }
        
        /* Modal */
        .modal { /* Styles de la modal ici, repris de scanner.css */ }
        .modal-body ul { list-style: none; padding: 0; }
        .modal-body li { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; margin-bottom: 8px; }

        /* Login */
        .login-container { max-width: 400px; margin: 100px auto; padding: 40px; background: var(--color-surface); border-radius: var(--radius-lg); }
        .error-message { background: rgba(244, 67, 54, 0.1); border: 1px solid #f44336; color: #f44336; padding: 12px; border-radius: 8px; display: none; margin-bottom: 15px; }
    </style>
</head>
<body>

    <!-- √âCRAN DE CONNEXION (initialement visible) -->
    <div id="login-screen" class="login-container">
        <h1 style="text-align: center; margin-bottom: 30px;">üîê Admin En-Bus</h1>
        <div id="login-error" class="error-message"></div>
        <form id="login-form" style="display: flex; flex-direction: column; gap: 20px;">
            <input type="text" id="username" class="form-control" placeholder="Nom d'utilisateur" required>
            <input type="password" id="password" class="form-control" placeholder="Mot de passe" required>
            <button type="submit" class="btn btn-primary btn-large">Se connecter</button>
        </form>
    </div>

    <!-- DASHBOARD (initialement cach√©) -->
    <div id="dashboard" class="admin-container" style="display: none;">
        <div class="header-bar">
            <h1>üìä Dashboard Super Admin</h1>
            <button id="logout-btn" class="btn btn-secondary">D√©connexion</button>
        </div>
        
        <div class="stats-grid" id="stats"></div>
        
        <div class="content-card">
            <h2>Toutes les r√©servations</h2>
            
            <div class="filters">
                <input type="text" id="search-input" class="search-input" placeholder="Rechercher par N¬∞, nom, t√©l√©phone...">
                <button class="filter-btn active" data-status="all">Tous</button>
                <button class="filter-btn" data-status="En attente de paiement">En attente</button>
                <button class="filter-btn" data-status="Confirm√©">Confirm√©</button>
                <button class="filter-btn" data-status="Annul√©">Annul√©</button>
            </div>

            <div class="table-wrapper">
                <table id="reservations-table">
                    <thead>
                        <tr>
                            <th>N¬∞ R√©servation</th>
                            <th>Date Voyage</th>
                            <th>Trajet</th>
                            <th>Passager Principal</th>
                            <th>Prix</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reservations-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL POUR LES D√âTAILS -->
    <div id="details-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">D√©tails de la r√©servation</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000/api'
            : 'https://en-bus-app.onrender.com/api'; // Remplacez par votre URL Render
        
        let allReservations = []; // Cache pour les donn√©es
        
        // ============================================
        // AUTHENTIFICATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('admin_token');
            if (token) {
                showDashboard();
                loadAdminData();
            } else {
                showLogin();
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            errorDiv.style.display = 'none';

            try {
                const response = await fetch(`${API_URL}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Erreur de connexion');
                
                localStorage.setItem('admin_token', data.token);
                showDashboard();
                loadAdminData();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('admin_token');
            showLogin();
        });

        function showLogin() {
            document.getElementById('login-screen').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        // ============================================
        // CHARGEMENT DES DONN√âES
        // ============================================
        async function loadAdminData() {
            const token = localStorage.getItem('admin_token');
            if (!token) { showLogin(); return; }

            try {
                const response = await fetch(`${API_URL}/admin/reservations`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 401 || response.status === 403) {
                    handleLogout();
                    return;
                }
                const data = await response.json();
                allReservations = data.reservations;
                
                displayStats(data.stats);
                renderTable(allReservations);
                
            } catch (error) {
                console.error('Erreur chargement donn√©es admin:', error);
                alert('Session expir√©e ou erreur serveur. Veuillez vous reconnecter.');
                handleLogout();
            }
        }
        
        function displayStats(stats) {
            document.getElementById('stats').innerHTML = `
                <div class="stat-card"><div class="stat-value">${stats.total}</div><div class="stat-label">Total</div></div>
                <div class="stat-card"><div class="stat-value" style="color: #4caf50;">${stats.confirmed}</div><div class="stat-label">Confirm√©es</div></div>
                <div class="stat-card"><div class="stat-value" style="color: #ffc107;">${stats.pending}</div><div class="stat-label">En attente</div></div>
                <div class="stat-card"><div class="stat-value" style="color: #f44336;">${stats.cancelled + stats.expired}</div><div class="stat-label">Annul√©es/Expir√©es</div></div>
            `;
        }

        // ============================================
        // AFFICHAGE & FILTRES
        // ============================================
        function renderTable(reservations) {
            const tbody = document.getElementById('reservations-body');
            if (reservations.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 40px;">Aucune r√©servation trouv√©e.</td></tr>`;
                return;
            }
            tbody.innerHTML = reservations.map(r => {
                const passenger = r.passengers[0] || {};
                return `
                    <tr>
                        <td><strong>${r.bookingNumber}</strong></td>
                        <td>${new Date(r.date).toLocaleDateString('fr-FR')}</td>
                        <td>${r.route.from} ‚Üí ${r.route.to}</td>
                        <td>${passenger.name || 'N/A'}<br><small>${passenger.phone || 'N/A'}</small></td>
                        <td>${r.totalPrice}</td>
                        <td><span class="reservation-status status-${r.status.toLowerCase().replace(/ /g, '-')}">${r.status}</span></td>
                        <td class="actions-cell">
                            <button class="btn btn-small btn-secondary" onclick="showDetails('${r.bookingNumber}')">üëÅÔ∏è Voir</button>
                            ${r.status === 'En attente de paiement' ? `<button class="btn btn-small btn-confirm" onclick="confirmPayment('${r.bookingNumber}')">‚úÖ Confirmer</button>` : ''}
                            ${r.status !== 'Annul√©' && r.status !== 'Expir√©' ? `<button class="btn btn-small btn-cancel" onclick="cancelReservation('${r.bookingNumber}')">‚ùå Annuler</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        document.getElementById('search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const activeStatus = document.querySelector('.filter-btn.active').dataset.status;
            
            let filtered = allReservations.filter(r => 
                r.bookingNumber.toLowerCase().includes(searchTerm) ||
                (r.passengers[0]?.name.toLowerCase().includes(searchTerm)) ||
                (r.passengers[0]?.phone.includes(searchTerm))
            );
            
            if (activeStatus !== 'all') {
                filtered = filtered.filter(r => r.status === activeStatus);
            }
            renderTable(filtered);
        });

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('search-input').dispatchEvent(new Event('input'));
            });
        });

        // ============================================
        // ACTIONS ADMIN
        // ============================================
        async function confirmPayment(bookingNumber) {
            if (!confirm(`Confirmer le paiement pour la r√©servation ${bookingNumber} ?`)) return;
            await performAction('confirm-payment', bookingNumber, 'PATCH');
        }

        async function cancelReservation(bookingNumber) {
            if (!confirm(`Voulez-vous vraiment annuler la r√©servation ${bookingNumber} ?`)) return;
            await performAction('cancel', bookingNumber, 'PATCH');
        }

        async function performAction(action, bookingNumber, method) {
            const token = localStorage.getItem('admin_token');
            try {
                const response = await fetch(`${API_URL}/reservations/${bookingNumber}/${action}`, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                alert(`Action "${action}" r√©ussie !`);
                loadAdminData(); // Recharger les donn√©es
            } catch (error) {
                alert(`Erreur: ${error.message}`);
            }
        }

        function showDetails(bookingNumber) {
            const reservation = allReservations.find(r => r.bookingNumber === bookingNumber);
            if (!reservation) return;

            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = `
                <h3>Passagers</h3>
                <ul>
                    ${reservation.passengers.map(p => `<li><strong>${p.name}</strong> (${p.phone}) - Si√®ge: ${p.seat}</li>`).join('')}
                </ul>
                <hr style="margin: 15px 0;">
                <h3>D√©tails du paiement</h3>
                <p><strong>M√©thode:</strong> ${reservation.paymentMethod}</p>
                <p><strong>Prix Total:</strong> ${reservation.totalPrice}</p>
                <p><strong>Statut:</strong> ${reservation.status}</p>
                ${reservation.paymentDeadline ? `<p><strong>Deadline Paiement:</strong> ${new Date(reservation.paymentDeadline).toLocaleString('fr-FR')}</p>` : ''}
            `;
            document.getElementById('modal-title').textContent = `D√©tails - ${bookingNumber}`;
            document.getElementById('details-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('details-modal').style.display = 'none';
        }

        // Lancement initial
        // loadAdminData(); // D√©j√† appel√© via DOMContentLoaded
        setInterval(loadAdminData, 30000); // Rafra√Æchir toutes les 30s
    </script>
</body>
</html>