<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Admin - En-Bus</title>

    <!-- Google Fonts Professional -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet" />

    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

    <style>
        /* ============================================
       üé® VARIABLES & RESET - TH√àME EN-BUS
       ============================================ */
        :root {
            /* Couleurs En-Bus */
            --primary: #73d700;
            --primary-dark: #5cb300;
            --primary-light: #8ee033;
            --accent: #00d9ff;
            --accent-dark: #00b8d4;

            /* Bleu sombre (background) */
            --dark-bg: #0a0e27;
            --dark-surface: #151a30;
            --dark-elevated: #1e2541;
            --dark-border: #2a3256;

            /* Statuts */
            --status-confirmed: #73d700;
            --status-pending: #ffa726;
            --status-cancelled: #ef5350;
            --status-expired: #78909c;

            /* Neutrals */
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;

            /* Texte */
            --text-primary: #ffffff;
            --text-secondary: #b0bac9;
            --text-muted: #6b7a99;

            /* Typographie */
            --font-primary: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
                sans-serif;
            --font-mono: "JetBrains Mono", "Courier New", monospace;

            /* Espacements */
            --spacing-xs: 0.5rem;
            --spacing-sm: 0.75rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;

            /* Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;

            /* Shadows */
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4),
                0 2px 4px -2px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5),
                0 4px 6px -4px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6),
                0 8px 10px -6px rgba(0, 0, 0, 0.5);

            /* Glow effects */
            --glow-green: 0 0 20px rgba(115, 215, 0, 0.4);
            --glow-cyan: 0 0 20px rgba(0, 217, 255, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: var(--dark-bg);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ============================================
       üîê LOGIN SCREEN
       ============================================ */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg,
                    var(--dark-bg) 0%,
                    #0d1430 50%,
                    #0a1228 100%);
            padding: var(--spacing-lg);
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle,
                    rgba(115, 215, 0, 0.05) 0%,
                    transparent 70%);
            animation: pulse 8s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.5;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        .login-card {
            background: var(--dark-surface);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl), 0 0 40px rgba(115, 215, 0, 0.1);
            border: 1px solid var(--dark-border);
            padding: var(--spacing-2xl);
            width: 100%;
            max-width: 420px;
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            z-index: 1;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .login-logo {
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
            filter: drop-shadow(var(--glow-green));
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .login-title {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--spacing-xs);
            letter-spacing: -0.5px;
        }

        .login-subtitle {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            padding: 0.875rem 1rem;
            font-size: 0.95rem;
            font-family: var(--font-primary);
            border: 2px solid var(--dark-border);
            border-radius: var(--radius-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--dark-elevated);
            color: var(--text-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--dark-surface);
            box-shadow: 0 0 0 3px rgba(115, 215, 0, 0.15), var(--glow-green);
        }

        .form-control::placeholder {
            color: var(--text-muted);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: 0.875rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 700;
            font-family: var(--font-primary);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--primary-dark) 100%);
            color: var(--dark-bg);
            width: 100%;
            box-shadow: 0 4px 15px rgba(115, 215, 0, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(115, 215, 0, 0.5), var(--glow-green);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .error-message {
            display: none;
            background: rgba(239, 83, 80, 0.1);
            border: 1px solid rgba(239, 83, 80, 0.3);
            color: #ef5350;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            margin-bottom: var(--spacing-lg);
        }

        .error-message.show {
            display: block;
            animation: shake 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97);
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        /* ============================================
       üìä DASHBOARD LAYOUT
       ============================================ */
        .dashboard {
            display: none;
            min-height: 100vh;
            background: var(--dark-bg);
        }

        .dashboard.active {
            display: grid;
            grid-template-columns: 280px 1fr;
        }

        /* Sidebar */
        .sidebar {
            background: var(--dark-surface);
            border-right: 1px solid var(--dark-border);
            color: var(--text-primary);
            padding: var(--spacing-lg);
            height: 100vh;
            position: sticky;
            top: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding-bottom: var(--spacing-lg);
            border-bottom: 1px solid var(--dark-border);
            margin-bottom: var(--spacing-lg);
        }

        .sidebar-logo {
            font-size: 1.75rem;
            font-weight: 900;
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
        }

        .sidebar-nav {
            list-style: none;
            flex: 1;
        }

        .nav-item {
            margin-bottom: var(--spacing-xs);
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: 0.875rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.2s;
            position: relative;
        }

        .nav-link::before {
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 0;
            background: var(--primary);
            border-radius: 0 3px 3px 0;
            transition: height 0.3s;
        }

        .nav-link:hover {
            background: var(--dark-elevated);
            color: var(--text-primary);
        }

        .nav-link.active {
            background: rgba(115, 215, 0, 0.1);
            color: var(--primary);
            box-shadow: inset 0 0 20px rgba(115, 215, 0, 0.05);
        }

        .nav-link.active::before {
            height: 60%;
        }

        .nav-icon {
            font-size: 1.35rem;
        }

        .sidebar-footer {
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--dark-border);
        }

        .btn-logout {
            width: 100%;
            background: var(--dark-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--dark-border);
            font-weight: 600;
        }

        .btn-logout:hover {
            background: rgba(239, 83, 80, 0.1);
            border-color: #ef5350;
            color: #ef5350;
            box-shadow: 0 0 15px rgba(239, 83, 80, 0.2);
        }

        /* Main Content */
        .main-content {
            padding: var(--spacing-xl);
            overflow-y: auto;
            height: 100vh;
            background: var(--dark-bg);
        }

        .page-header {
            margin-bottom: var(--spacing-xl);
        }

        .page-title {
            font-size: 2.25rem;
            font-weight: 800;
            background: linear-gradient(135deg,
                    var(--text-primary) 0%,
                    var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--spacing-xs);
            letter-spacing: -1px;
        }

        .page-subtitle {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        /* ============================================
       üìà STATS CARDS
       ============================================ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .stat-card {
            background: var(--dark-surface);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--dark-border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg,
                    var(--primary) 0%,
                    var(--accent) 100%);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg), 0 0 30px rgba(115, 215, 0, 0.1);
            border-color: rgba(115, 215, 0, 0.3);
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-md);
        }

        .stat-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            font-size: 1.5rem;
        }

        .stat-icon.primary {
            background: rgba(115, 215, 0, 0.15);
            color: var(--primary);
            box-shadow: 0 0 20px rgba(115, 215, 0, 0.2);
        }

        .stat-icon.success {
            background: rgba(115, 215, 0, 0.15);
            color: var(--primary);
            box-shadow: 0 0 20px rgba(115, 215, 0, 0.2);
        }

        .stat-icon.warning {
            background: rgba(255, 167, 38, 0.15);
            color: #ffa726;
            box-shadow: 0 0 20px rgba(255, 167, 38, 0.2);
        }

        .stat-icon.danger {
            background: rgba(239, 83, 80, 0.15);
            color: #ef5350;
            box-shadow: 0 0 20px rgba(239, 83, 80, 0.2);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--text-primary);
            line-height: 1;
            text-shadow: 0 0 30px rgba(115, 215, 0, 0.3);
        }

        /* ============================================
       üìã CONTENT CARDS
       ============================================ */
        .content-card {
            background: var(--dark-surface);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--dark-border);
            margin-bottom: var(--spacing-xl);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--dark-border);
        }

        .card-title {
            font-size: 1.375rem;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        /* ============================================
       üîç FILTERS & SEARCH
       ============================================ */
        .filters {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
        }

        .filter-pills {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }

        .filter-pill {
            padding: 0.625rem 1.25rem;
            background: var(--dark-elevated);
            color: var(--text-secondary);
            border: 2px solid transparent;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-pill:hover {
            background: var(--dark-border);
            color: var(--text-primary);
        }

        .filter-pill.active {
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--primary-dark) 100%);
            color: var(--dark-bg);
            border-color: var(--primary);
            box-shadow: var(--glow-green);
        }

        /* ============================================
       üìä TABLE
       ============================================ */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-lg);
            border: 1px solid var(--dark-border);
            background: var(--dark-elevated);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        thead {
            background: rgba(115, 215, 0, 0.05);
            border-bottom: 2px solid var(--dark-border);
        }

        th {
            padding: 1.125rem 1rem;
            text-align: left;
            font-weight: 800;
            color: var(--primary);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        td {
            padding: 1.125rem 1rem;
            border-bottom: 1px solid var(--dark-border);
            color: var(--text-secondary);
        }

        tbody tr {
            transition: all 0.2s;
        }

        tbody tr:hover {
            background: rgba(115, 215, 0, 0.03);
            box-shadow: inset 0 0 0 1px rgba(115, 215, 0, 0.1);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.875rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: rgba(115, 215, 0, 0.2);
            color: var(--primary);
            box-shadow: 0 0 15px rgba(115, 215, 0, 0.2);
        }

        .badge-warning {
            background: rgba(255, 167, 38, 0.2);
            color: #ffa726;
            box-shadow: 0 0 15px rgba(255, 167, 38, 0.2);
        }

        .badge-danger {
            background: rgba(239, 83, 80, 0.2);
            color: #ef5350;
            box-shadow: 0 0 15px rgba(239, 83, 80, 0.2);
        }

        .badge-gray {
            background: rgba(120, 144, 156, 0.2);
            color: var(--status-expired);
        }

        .actions-cell {
            display: flex;
            gap: var(--spacing-xs);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            border-radius: var(--radius-sm);
            font-weight: 700;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
        }

        .btn-ghost {
            background: var(--dark-elevated);
            border: 1px solid var(--dark-border);
            color: var(--text-secondary);
        }

        .btn-ghost:hover {
            background: var(--dark-border);
            color: var(--text-primary);
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(115, 215, 0, 0.2);
        }

        .btn-success {
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--primary-dark) 100%);
            color: var(--dark-bg);
            box-shadow: 0 0 15px rgba(115, 215, 0, 0.3);
        }

        .btn-success:hover {
            transform: scale(1.05);
            box-shadow: var(--glow-green);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
            color: white;
            box-shadow: 0 0 15px rgba(239, 83, 80, 0.3);
        }

        .btn-danger:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(239, 83, 80, 0.5);
        }

        /* ============================================
       üóìÔ∏è FORM GRID
       ============================================ */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .form-group-full {
            grid-column: 1 / -1;
        }

        .days-selector {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .day-checkbox {
            position: relative;
        }

        .day-checkbox input {
            position: absolute;
            opacity: 0;
        }

        .day-checkbox label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 56px;
            background: var(--dark-elevated);
            border: 2px solid var(--dark-border);
            border-radius: var(--radius-md);
            font-weight: 800;
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .day-checkbox input:checked+label {
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--primary-dark) 100%);
            border-color: var(--primary);
            color: var(--dark-bg);
            transform: scale(1.05);
            box-shadow: var(--glow-green);
        }

        .day-checkbox label:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        /* ============================================
       ü™ü MODAL
       ============================================ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 14, 39, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-lg);
            backdrop-filter: blur(8px);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-dialog {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: var(--radius-xl);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-xl), 0 0 60px rgba(115, 215, 0, 0.15);
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-xl);
            border-bottom: 1px solid var(--dark-border);
            background: rgba(115, 215, 0, 0.03);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-close {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: var(--dark-elevated);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid var(--dark-border);
        }

        .modal-close:hover {
            background: rgba(239, 83, 80, 0.1);
            color: #ef5350;
            transform: rotate(90deg);
            border-color: #ef5350;
        }

        .modal-body {
            padding: var(--spacing-xl);
            overflow-y: auto;
            max-height: calc(90vh - 140px);
        }

        /* ============================================
       üí∫ SEAT MAP
       ============================================ */
        .seat-map-container {
            background: var(--dark-elevated);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin: var(--spacing-lg) 0;
            border: 1px solid var(--dark-border);
        }

        .seat-map {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--spacing-sm);
            max-width: 350px;
            margin: 0 auto;
        }

        .seat {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            font-weight: 800;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
        }

        .seat:hover:not(.seat-occupied) {
            transform: scale(1.15);
            z-index: 10;
        }

        .seat-available {
            background: linear-gradient(135deg,
                    var(--primary) 0%,
                    var(--primary-dark) 100%);
            color: var(--dark-bg);
            box-shadow: 0 0 15px rgba(115, 215, 0, 0.3);
        }

        .seat-available:hover {
            box-shadow: var(--glow-green);
        }

        .seat-occupied {
            background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
            color: white;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .seat-blocked {
            background: var(--dark-border);
            color: var(--text-muted);
            border: 2px dashed var(--text-muted);
        }

        .seat-blocked:hover {
            box-shadow: 0 0 15px rgba(120, 144, 156, 0.3);
        }

        .seat-aisle {
            visibility: hidden;
        }

        .seat-legend {
            display: flex;
            justify-content: center;
            gap: var(--spacing-xl);
            margin-top: var(--spacing-xl);
            font-size: 0.875rem;
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--dark-border);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            color: var(--text-secondary);
            font-weight: 600;
        }

        .legend-box {
            width: 24px;
            height: 24px;
            border-radius: var(--radius-sm);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        /* ============================================
       üì¢ NOTIFICATIONS
       ============================================ */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .notification {
            background: var(--dark-surface);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md) var(--spacing-lg);
            box-shadow: var(--shadow-lg), 0 0 30px rgba(0, 0, 0, 0.5);
            border-left: 4px solid;
            border: 1px solid var(--dark-border);
            min-width: 320px;
            max-width: 420px;
            animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(450px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(450px);
                opacity: 0;
            }
        }

        .notification.success {
            border-left-color: var(--primary);
            box-shadow: var(--shadow-lg), 0 0 30px rgba(115, 215, 0, 0.2);
        }

        .notification.error {
            border-left-color: #ef5350;
            box-shadow: var(--shadow-lg), 0 0 30px rgba(239, 83, 80, 0.2);
        }

        .notification.warning {
            border-left-color: #ffa726;
            box-shadow: var(--shadow-lg), 0 0 30px rgba(255, 167, 38, 0.2);
        }

        .notification.info {
            border-left-color: var(--accent);
            box-shadow: var(--shadow-lg), 0 0 30px rgba(0, 217, 255, 0.2);
        }

        .notification-icon {
            font-size: 1.75rem;
            flex-shrink: 0;
            filter: drop-shadow(0 0 10px currentColor);
        }

        .notification.success .notification-icon {
            color: var(--primary);
        }

        .notification.error .notification-icon {
            color: #ef5350;
        }

        .notification.warning .notification-icon {
            color: #ffa726;
        }

        .notification.info .notification-icon {
            color: var(--accent);
        }

        .notification-content {
            flex: 1;
        }

        .notification-message {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        /* ============================================
   üí∫ STYLES POUR LA S√âLECTION DES SI√àGES
   ============================================ */

        .seat.selected {
            background: #2196f3 !important;
            color: white !important;
            border: 3px solid white !important;
            transform: scale(1.1) !important;
            z-index: 10;
            box-shadow: 0 0 20px rgba(33, 150, 243, 0.6) !important;
        }

        .seat:not(.seat-occupied):hover {
            cursor: pointer;
            transform: scale(1.05);
        }

        .seat-occupied {
            cursor: not-allowed !important;
            opacity: 0.6;
        }


        /* DANS Admin/index.html, dans <style> */

        .seat.selected {
            background: #2196F3 !important;
            /* Bleu vif pour la s√©lection */
            color: white !important;
            border: 3px solid white !important;
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 0 20px rgba(33, 150, 243, 0.6);
        }

        /* ============================================
       üì± RESPONSIVE
       ============================================ */
        @media (max-width: 1024px) {
            .dashboard.active {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: var(--spacing-md);
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
            }

            .search-input {
                min-width: 100%;
            }

            .page-title {
                font-size: 1.75rem;
            }

            .table-container {
                font-size: 0.75rem;
            }

            th,
            td {
                padding: 0.75rem 0.5rem;
            }

            .btn-icon {
                width: 32px;
                height: 32px;
                font-size: 1rem;
            }

            .seat.selected {
                background: #2196f3 !important;
                color: white !important;
                border: 3px solid white !important;
                transform: scale(1.1);
                z-index: 10;
                box-shadow: 0 0 20px rgba(33, 150, 243, 0.5);
            }
        }

        /* ============================================
       üé≠ UTILITIES
       ============================================ */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .font-mono {
            font-family: var(--font-mono);
        }

        .font-bold {
            font-weight: 700;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-xs {
            font-size: 0.75rem;
        }

        .mb-0 {
            margin-bottom: 0;
        }

        .mt-4 {
            margin-top: var(--spacing-lg);
        }

        /* ============================================
       ‚ú® SCROLLBAR CUSTOM
       ============================================ */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--dark-border);
            border-radius: 6px;
            border: 2px solid var(--dark-bg);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* ============================================
   üé¨ GESTION DES ONGLETS (TABS)
   ============================================ */

        .tab-content {
            display: none;
            /* Cache toutes les sections par d√©faut */
        }

        .tab-content.active {
            display: block;
            /* Affiche uniquement celle qui est active */
            animation: fadeIn 0.4s ease-in-out;
            /* Ajoute une animation de fondu */
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============================================
   ‚è±Ô∏è CHRONOM√àTRE DE PAIEMENT EN AGENCE
   ============================================ */

        .payment-countdown {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 13px;
            font-family: var(--font-mono);
            letter-spacing: 0.5px;
        }

        .payment-countdown.urgent {
            background: linear-gradient(135deg,
                    rgba(239, 83, 80, 0.15) 0%,
                    rgba(229, 57, 53, 0.15) 100%);
            color: #ef5350;
            border: 2px solid rgba(239, 83, 80, 0.3);
            animation: pulse-urgent 2s ease-in-out infinite;
        }

        .payment-countdown.warning {
            background: linear-gradient(135deg,
                    rgba(255, 167, 38, 0.15) 0%,
                    rgba(251, 140, 0, 0.15) 100%);
            color: #ffa726;
            border: 2px solid rgba(255, 167, 38, 0.3);
        }

        .payment-countdown.normal {
            background: linear-gradient(135deg,
                    rgba(115, 215, 0, 0.15) 0%,
                    rgba(92, 179, 0, 0.15) 100%);
            color: var(--primary);
            border: 2px solid rgba(115, 215, 0, 0.3);
        }

        @keyframes pulse-urgent {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(239, 83, 80, 0.7);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(239, 83, 80, 0);
            }
        }

        .countdown-icon {
            font-size: 16px;
            animation: tick 1s infinite;
        }

        @keyframes tick {

            0%,
            50% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .countdown-time {
            font-weight: 900;
            font-size: 14px;
        }

        .countdown-label {
            font-size: 11px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Badge am√©lior√© pour les r√©servations en attente */
        .reservation-row.pending-payment {
            background: rgba(255, 193, 7, 0.03);
            border-left: 4px solid #ffc107;
        }

        .reservation-row.expired-payment {
            background: rgba(239, 83, 80, 0.03);
            border-left: 4px solid #ef5350;
            opacity: 0.6;
        }



        /* DANS Admin/index.html, dans <style> */

        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 14, 39, 0.85);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            animation: fadeIn 0.3s ease;
        }

        .custom-modal-card {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl), 0 0 60px rgba(115, 215, 0, 0.15);
            max-width: 500px;
            width: 100%;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            overflow: hidden;
        }

        .custom-modal-header {
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid var(--dark-border);
        }

        .custom-modal-icon {
            font-size: 2.5rem;
            filter: drop-shadow(0 0 10px currentColor);
        }

        #admin-confirm-icon.warning {
            color: #ffa726;
        }

        #admin-confirm-icon.danger {
            color: #f44336;
        }

        #admin-confirm-icon.success {
            color: var(--primary);
        }

        .custom-modal-body {
            padding: 24px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        #admin-confirm-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-primary);
            margin: 0;
        }

        #admin-confirm-message {
            white-space: pre-line;
            /* Respecte les sauts de ligne */
        }

        .custom-modal-footer {
            display: flex;
            gap: 12px;
            padding: 16px 24px;
            background-color: var(--dark-elevated);
            justify-content: flex-end;
        }

        .custom-modal-footer .btn {
            min-width: 120px;
        }

        /* DANS index.html (balise <style>) ou dans style.css */

        /* Pour la carte de r√©sultat */
        .bus-card-location {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text-secondary);
            background-color: rgba(var(--color-background-rgb), 0.7);
            padding: 6px 10px;
            border-radius: var(--radius-base);
            margin-top: 8px;
            display: inline-block;
        }

        /* Pour le billet PDF/HTML */
        .location-detail {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            /* ou var(--color-text-secondary) */
            margin-top: 4px;
        }




        /* DANS Admin/index.html, dans <style> */

        .transaction-id-display {
            margin-top: 8px;
            padding: 6px 10px;
            font-size: 12px;
            font-family: var(--font-mono);
            border-radius: var(--radius-sm);
            background-color: rgba(var(--primary-light), 0.1);
            color: var(--primary);
            border: 1px solid rgba(var(--primary-light), 0.3);
            font-weight: 600;
        }

        .transaction-id-display strong {
            color: white;
        }

        .transaction-id-display.pending {
            background-color: rgba(255, 167, 38, 0.1);
            color: #ffa726;
            border-color: rgba(255, 167, 38, 0.3);
            font-style: italic;
        }


        .tab-content.active {
            display: block;
            /* ‚úÖ C'est √ßa qui rend l'onglet visible */
            animation: fadeIn 0.4s ease-in-out;
        }


        /* DANS <style> */

.tab-content {
    display: none;
}

/* On utilise l'ID pour √™tre plus sp√©cifique et !important pour forcer */
#tab-reservations.active,
#tab-report-requests.active,
#tab-trips.active,
#tab-templates.active,
#tab-destinations.active,
#tab-settings.active {
    display: block !important;
    animation: fadeIn 0.4s ease-in-out;
}


        /* ============================================
   üì± RESPONSIVE - TABLEAU DEMANDES DE REPORT
   ============================================ */

        @media (max-width: 1200px) {
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 1000px;
                /* Force le tableau √† garder sa largeur */
            }
        }

        @media (max-width: 768px) {
            #tab-report-requests .stats-grid {
                grid-template-columns: 1fr;
                /* Une seule colonne sur mobile */
            }

            #tab-report-requests .card-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            #tab-report-requests .card-header .btn {
                width: 100%;
            }

            .actions-cell {
                white-space: nowrap;
                /* Emp√™che les boutons de se casser */
            }
        }



        /* ============================================
   üî• FIX D'AFFICHAGE POUR LES TABLEAUX
   ============================================ */

/* On s'assure que le conteneur est visible */
#tab-destinations .table-container {
    display: block !important;
    min-height: 200px; /* Force une hauteur minimale */
}

/* On cible sp√©cifiquement le tbody des destinations */
#destinations-body {
    display: table-row-group !important; /* Mode d'affichage normal pour un tbody */
    visibility: visible !important;
    opacity: 1 !important;
}

/* On cible les lignes √† l'int√©rieur */
#destinations-body tr {
    display: table-row !important; /* Mode d'affichage normal pour une ligne */
    visibility: visible !important;
    opacity: 1 !important;
}

/* On cible les cellules √† l'int√©rieur */
#destinations-body td {
    display: table-cell !important; /* Mode d'affichage normal pour une cellule */
    padding: 1rem !important; /* Force un padding pour donner de la hauteur */
    visibility: visible !important;
    opacity: 1 !important;
    color: white !important; /* Force la couleur du texte */
    border-bottom: 1px solid var(--dark-border);
}
    </style>
</head>

<body>
    <!-- ============================================
         üîê LOGIN SCREEN
         ============================================ -->
    <div id="login-screen" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">üöå</div>
                <h1 class="login-title">En-Bus Admin</h1>
                <p class="login-subtitle">Connectez-vous pour acc√©der au dashboard</p>
            </div>

            <div id="login-error" class="error-message"></div>

            <form id="login-form">
                <div class="form-group">
                    <label for="username" class="form-label">Nom d'utilisateur</label>
                    <input type="text" id="username" class="form-control" placeholder="Entrez votre nom d'utilisateur"
                        required autocomplete="username" />
                </div>

                <div class="form-group">
                    <label for="password" class="form-label">Mot de passe</label>
                    <input type="password" id="password" class="form-control" placeholder="Entrez votre mot de passe"
                        required autocomplete="current-password" />
                </div>

                <button type="submit" class="btn btn-primary">
                    <span>üîì</span>
                    Se connecter
                </button>
            </form>
        </div>
    </div>

    <!-- ============================================
         üìä DASHBOARD
         ============================================ -->
    <div id="dashboard" class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">En-Bus</div>
            </div>

            <nav>
                <ul class="sidebar-nav">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" data-tab="reservations">
                            <span class="nav-icon">üìã</span>
                            <span>R√©servations</span>
                        </a>
                    </li>

                    <!-- ‚úÖ AJOUTER SEULEMENT LE LIEN ICI -->
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-tab="report-requests">
                            <span class="nav-icon">üîÑ</span>
                            <span>Demandes de report</span>
                        </a>
                    </li>

                    <li class="nav-item">
                        <a href="#" class="nav-link" data-tab="trips">
                            <span class="nav-icon">üóìÔ∏è</span>
                            <span>Programmation</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-tab="templates">
                            <span class="nav-icon">üõ£Ô∏è</span>
                            <span>Mod√®les de trajets</span>
                        </a>
                    </li>

                    <!-- DANS la sidebar, apr√®s les autres liens -->
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-tab="destinations">
                            <span class="nav-icon">üèôÔ∏è</span>
                            <span>Destinations</span>
                        </a>
                    </li>

                    <!-- ‚úÖ AJOUTEZ CE LIEN ICI -->
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="openSettingsModal()">
                            <span class="nav-icon">‚öôÔ∏è</span>
                            <span>Param√®tres</span>
                        </a>
                    </li>


                </ul>



            </nav>

            <div class="sidebar-footer">
                <button id="logout-btn" class="btn btn-logout">
                    <span>üö™</span>
                    D√©connexion
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- TAB: R√©servations -->
            <!-- ============================================
         1. ONGLET: R√©servations
         ============================================ -->
            <div id="tab-reservations" class="tab-content active">
                <div class="page-header">
                    <h1 class="page-title">R√©servations</h1>
                    <p class="page-subtitle">
                        G√©rez toutes les r√©servations en temps r√©el
                    </p>
                </div>

                <!-- Stats -->
                <div id="stats-grid" class="stats-grid">
                    <!-- G√©n√©r√© dynamiquement par JavaScript -->
                </div>

                <!-- Filters & Table -->
                <div class="content-card">
                    <div class="filters">
                        <input type="text" id="search-input" class="form-control search-input"
                            placeholder="üîç Rechercher par N¬∞, nom, t√©l, preuve..." oninput="applyFilters()" />

                        <!-- ‚úÖ FILTRE PAR M√âTHODE DE PAIEMENT -->
                        <select id="filter-payment-method" class="form-control" style="flex: 0 1 200px;"
                            onchange="applyFilters()">
                            <option value="all">Toutes les m√©thodes</option>
                            <option value="MTN">MTN</option>
                            <option value="AIRTEL">Airtel</option>
                            <option value="AGENCY">Agence</option>
                        </select>

                        <!-- ‚úÖ FILTRE PAR NUM√âRO DE BUS -->
                        <input type="text" id="filter-bus-id" class="form-control" style="flex: 0 1 200px;"
                            placeholder="Filtrer par N¬∞ Bus..." oninput="applyFilters()">

                        <div class="filter-pills">
                            <button class="filter-pill active" data-status="all">Tous</button>
                            <button class="filter-pill" data-status="Confirm√©">Confirm√©</button>
                            <button class="filter-pill" data-status="En attente de paiement">En attente</button>
                            <button class="filter-pill" data-status="Annul√©">Annul√©</button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>N¬∞ R√©servation</th>
                                    <th>Date Voyage / N¬∞ Bus</th>
                                    <th>Trajet</th>
                                    <th>Passager</th>
                                    <th>Prix / Preuve de Paiement</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reservations-body">
                                <!-- G√©n√©r√© dynamiquement par JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div> <!-- Fin de l'onglet R√©servations -->


            <!-- ============================================
         2. ONGLET: Demandes de report
         ============================================ -->
            <div id="tab-report-requests" class="tab-content">
                <div class="page-header">
                    <h1 class="page-title">Demandes de report</h1>
                    <p class="page-subtitle">
                        Validez les demandes de report apr√®s v√©rification du paiement
                    </p>
                </div>

                <!-- Stats pour les reports -->
                <div id="report-stats-grid" class="stats-grid">
                    <!-- G√©n√©r√© dynamiquement par JavaScript -->
                </div>

                <!-- Table des demandes -->
                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title">Demandes en attente et Historique</h2>

                        <!-- ‚úÖ CHAMP DE RECHERCHE -->
                        <input type="text" id="report-search-input" class="form-control"
                            style="flex: 1; max-width: 400px;" placeholder="Rechercher par N¬∞ r√©servation, nom, code..."
                            oninput="loadReportRequests()">

                        <button class="btn btn-secondary" onclick="loadReportRequests()">
                            üîÑ Actualiser
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>N¬∞ R√©servation</th>
                                    <th>Passager</th>
                                    <th>Trajet actuel</th>
                                    <th>Nouveau trajet</th>
                                    <th>Paiement & Preuve</th>
                                    <th>Demand√© le</th>
                                    <th>Actions</th>

                                </tr>
                            </thead>

                            <!-- ‚úÖ CETTE BALISE EST PROBABLEMENT MANQUANTE OU MAL √âCRITE -->
                            <tbody id="report-requests-body">
                                <!-- G√©n√©r√© dynamiquement -->
                            </tbody>

                        </table>
                    </div>
                </div>
            </div> <!-- Fin de l'onglet Demandes de report -->

            <!-- TAB: Programmation -->
            <div id="tab-trips" class="tab-content">
                <div class="page-header">
                    <h1 class="page-title">Programmation des Voyages</h1>
                    <p class="page-subtitle">Cr√©ez et g√©rez les voyages √† venir</p>
                </div>

                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title">Nouveau Voyage</h2>
                    </div>
                    <!-- DANS Admin/index.html -->

                    <form id="trip-creation-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="route-template" class="form-label">Mod√®le de trajet</label>
                                <select id="route-template" class="form-control" required>
                                    <option value="">S√©lectionnez un mod√®le</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="trip-dates" class="form-label">P√©riode</label>
                                <input type="text" id="trip-dates" class="form-control"
                                    placeholder="S√©lectionnez une date ou plage" required>
                            </div>

                            <div class="form-group">
                                <label for="seat-count" class="form-label">Nombre de si√®ges</label>
                                <input type="number" id="seat-count" class="form-control" value="61" min="10" max="100"
                                    required>
                            </div>

                            <div class="form-group form-group-full">
                                <label class="form-label">Jours de la semaine</label>
                                <div id="days-selector" class="days-selector">
                                    <!-- G√©n√©r√© dynamiquement -->
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="bus-identifier" class="form-label">Num√©ro du Bus (ex: B01)</label>
                                <input type="text" id="bus-identifier" class="form-control"
                                    placeholder="Identifiant unique" />
                            </div>

                            <div class="form-group">
                                <label for="highlight-badge" class="form-label">Badge de Mise en Avant
                                    (Optionnel)</label>
                                <input type="text" id="highlight-badge" class="form-control"
                                    placeholder="Ex: ‚≠ê Recommand√©, üéâ Promo">
                            </div>

                        </div> <!-- ‚úÖ CORRECTION : La balise de fermeture de .form-grid est maintenant ici -->

                        <button type="submit" class="btn btn-primary mt-4">
                            <span>‚ûï</span>
                            Programmer les voyages
                        </button>
                    </form>
                </div>


                <!-- DANS #tab-trips, avant le .content-card de la table -->

                <div class="content-card">
                    <h2 class="card-title">Filtres des voyages</h2>
                    <div class="filters" style="margin-top: 1rem;">
                        <!-- Filtre par Date -->
                        <div class="form-group" style="flex: 1;">
                            <label for="trip-filter-date" class="form-label">Filtrer par date</label>
                            <input type="text" id="trip-filter-date" class="form-control"
                                placeholder="S√©lectionner une date..." onchange="loadAllTrips()">
                        </div>

                        <!-- Filtre par Trajet -->
                        <div class="form-group" style="flex: 1;">
                            <label for="trip-filter-route" class="form-label">Filtrer par trajet</label>
                            <input type="text" id="trip-filter-route" class="form-control"
                                placeholder="Ex: Brazzaville ou Pointe-Noire" oninput="loadAllTrips()">
                        </div>

                        <!-- Filtre par N¬∞ de Bus -->
                        <div class="form-group" style="flex: 1;">
                            <label for="trip-filter-bus" class="form-label">Filtrer par N¬∞ Bus</label>
                            <input type="text" id="trip-filter-bus" class="form-control" placeholder="Ex: B50"
                                oninput="loadAllTrips()">
                        </div>
                    </div>
                </div>

                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title">Voyages Programm√©s</h2>
                    </div>
                    <div class="table-container">
                        <!-- Votre tableau existant -->
                    </div>
                </div>

                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title">Voyages Programm√©s</h2>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Trajet</th>
                                    <th>Compagnie</th>
                                    <th>N¬∞ Bus</th>
                                    <!-- ‚úÖ NOUVELLE COLONNE -->
                                    <th>Disponibilit√©</th>
                                    <th style="min-width: 180px">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="trips-body">
                                <!-- G√©n√©r√© dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB: Mod√®les -->
            <div id="tab-templates" class="tab-content">
                <div class="page-header">
                    <h1 class="page-title">Mod√®les de Trajets</h1>
                    <p class="page-subtitle">
                        Cr√©ez des mod√®les r√©utilisables pour vos lignes
                    </p>
                </div>

                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title">Nouveau Mod√®le</h2>
                    </div>

                    <form id="template-creation-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="template-from" class="form-label">Ville de d√©part</label>
                                <input type="text" id="template-from" class="form-control" placeholder="Ex: Yaound√©"
                                    required />
                            </div>


                            <!-- ‚úÖ AJOUTER CE CHAMP -->
                            <div class="form-group">
                                <label for="template-departure-location" class="form-label">Lieu de d√©part
                                    pr√©cis</label>
                                <input type="text" id="template-departure-location" class="form-control"
                                    placeholder="Ex: Agence de Ouenz√©">

                                <div class="form-group">
                                    <label for="template-to" class="form-label">Ville d'arriv√©e</label>
                                    <input type="text" id="template-to" class="form-control" placeholder="Ex: Douala"
                                        required />
                                </div>


                                <!-- ‚úÖ AJOUTER CE CHAMP -->
                                <div class="form-group">
                                    <label for="template-arrival-location" class="form-label">Lieu d'arriv√©e
                                        pr√©cis</label>
                                    <input type="text" id="template-arrival-location" class="form-control"
                                        placeholder="Ex: Agence du Grand March√©">
                                </div>

                                <div class="form-group">
                                    <label for="template-company" class="form-label">Compagnie</label>
                                    <input type="text" id="template-company" class="form-control"
                                        placeholder="Ex: Express VIP" required />
                                </div>

                                <div class="form-group">
                                    <label for="template-price" class="form-label">Prix (FCFA)</label>
                                    <input type="number" id="template-price" class="form-control" placeholder="5000"
                                        required />
                                </div>

                                <div class="form-group">
                                    <label for="template-departure" class="form-label">Heure de d√©part</label>
                                    <input type="text" id="template-departure" class="form-control" placeholder="08:00"
                                        required />
                                </div>

                                <div class="form-group">
                                    <label for="template-arrival" class="form-label">Heure d'arriv√©e</label>
                                    <input type="text" id="template-arrival" class="form-control" placeholder="12:00"
                                        required />
                                </div>
                            </div>

                            <!-- Type de trajet -->
                            <div class="form-group form-group-full">
                                <label class="form-label">Type de trajet</label>
                                <select id="template-trip-type" class="form-control" onchange="toggleTripOptions()">
                                    <option value="direct">Direct (sans arr√™t)</option>
                                    <option value="stops">Avec arr√™ts</option>
                                    <option value="connections">Avec correspondances</option>
                                </select>
                            </div>

                            <!-- Section arr√™ts (cach√©e par d√©faut) -->
                            <div id="stops-section" class="form-group form-group-full" style="display: none">
                                <label class="form-label">Arr√™ts interm√©diaires</label>
                                <div id="stops-container"></div>
                                <button type="button" class="btn btn-secondary" onclick="addStop()">
                                    + Ajouter un arr√™t
                                </button>
                            </div>

                            <!-- Section correspondances (cach√©e par d√©faut) -->
                            <div id="connections-section" class="form-group form-group-full" style="display: none">
                                <label class="form-label">Correspondances</label>
                                <div id="connections-container"></div>
                                <button type="button" class="btn btn-secondary" onclick="addConnection()">
                                    + Ajouter une correspondance
                                </button>
                            </div>

                            <div class="form-group form-group-full">
                                <label class="form-label">√âquipements disponibles</label>
                                <div style="display: flex; flex-wrap: wrap; gap: 12px">
                                    <label class="amenity-checkbox-label">
                                        <input type="checkbox" name="amenity" value="wifi" />
                                        <span>üì∂ Wi-Fi</span>
                                    </label>
                                    <label class="amenity-checkbox-label">
                                        <input type="checkbox" name="amenity" value="wc" />
                                        <span>üöª Toilettes</span>
                                    </label>
                                    <label class="amenity-checkbox-label">
                                        <input type="checkbox" name="amenity" value="clim" />
                                        <span>‚ùÑÔ∏è Climatisation</span>
                                    </label>
                                    <label class="amenity-checkbox-label">
                                        <input type="checkbox" name="amenity" value="prise" />
                                        <span>üîå Prises √©lectriques</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group form-group-full" style="
                  padding-top: 1rem;
                  margin-top: 1rem;
                  border-top: 1px solid var(--dark-border);
                ">
                                <h4 style="color: var(--primary); margin-bottom: 1rem">
                                    Options des bagages
                                </h4>

                                <div class="form-grid">
                                    <!-- Bagages standards -->
                                    <div class="form-group">
                                        <label for="standard-baggage-included" class="form-label">Bagages standards
                                            inclus</label>
                                        <input type="number" id="standard-baggage-included" class="form-control"
                                            value="1" min="0" />
                                    </div>
                                    <div class="form-group">
                                        <label for="standard-baggage-max" class="form-label">Max par passager</label>
                                        <input type="number" id="standard-baggage-max" class="form-control" value="5"
                                            min="1" />
                                    </div>
                                    <div class="form-group">
                                        <label for="standard-baggage-price" class="form-label">Prix par bagage
                                            suppl.</label>
                                        <input type="number" id="standard-baggage-price" class="form-control"
                                            value="2000" step="500" />
                                    </div>

                                    <!-- Bagages hors format -->
                                    <div class="form-group" style="
                      grid-column: 1 / -1;
                      margin-top: 1rem;
                      border-top: 1px dashed var(--dark-border);
                      padding-top: 1rem;
                    ">
                                        <label class="form-label">Bagages Hors Format (Grand sac, Colis...)</label>
                                    </div>
                                    <div class="form-group">
                                        <label for="oversized-baggage-max" class="form-label">Max par passager</label>
                                        <input type="number" id="oversized-baggage-max" class="form-control" value="2"
                                            min="0" />
                                    </div>
                                    <div class="form-group">
                                        <label for="oversized-baggage-price" class="form-label">Prix par unit√©</label>
                                        <input type="number" id="oversized-baggage-price" class="form-control"
                                            value="5000" step="500" />
                                    </div>
                                </div>
                            </div>

    

                            <button type="submit" class="btn btn-primary mt-4">
                                <span>üíæ</span>
                                Cr√©er le mod√®le
                            </button>
                    </form>
                </div>

                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title">Mod√®les Existants</h2>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Trajet</th>
                                    <th>Compagnie</th>
                                    <th>Prix</th>
                                    <th>Horaires</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="templates-body">
                                <!-- G√©n√©r√© dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>




            </div>


            <!-- ============================================
     ONGLET: GESTION DES DESTINATIONS (Version Saine)
     ============================================ -->
<div id="tab-destinations" class="tab-content">
    <div class="page-header">
        <h1 class="page-title">Gestion des Destinations</h1>
        <p class="page-subtitle">Ajoutez, modifiez ou d√©sactivez les villes desservies.</p>
    </div>

    <!-- Formulaire d'ajout -->
    <div class="content-card">
        <div class="card-header">
            <h2 class="card-title">Ajouter une nouvelle ville</h2>
        </div>
        <form id="destination-creation-form">
            <div class="form-grid">
                <div class="form-group">
                    <label for="dest-name" class="form-label">Nom de la ville</label>
                    <input type="text" id="dest-name" class="form-control" placeholder="Ex: Kinshasa" required>
                </div>
                <div class="form-group">
                    <label for="dest-country" class="form-label">Pays</label>
                    <input type="text" id="dest-country" class="form-control" placeholder="Ex: RDC" required>
                </div>
                <div class="form-group">
                    <label for="dest-coords" class="form-label">Coordonn√©es GPS</label>
                    <input type="text" id="dest-coords" class="form-control" placeholder="Ex: -4.44, 15.26">
                </div>
            </div>
            <button type="submit" class="btn btn-primary mt-4"><span>‚ûï</span> Ajouter la destination</button>
        </form>
    </div>

    <!-- Tableau des destinations existantes -->
    <div class="content-card">
        <div class="card-header">
            <h2 class="card-title">Villes existantes</h2>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Ville</th>
                        <th>Pays</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="destinations-body">
                    <!-- Contenu g√©n√©r√© par JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>


            </div>


        </main>
    </div>
    <!-- TAB: Param√®tres -->

    <!-- ============================================
         ü™ü MODAL
         ============================================ -->
    <div id="details-modal" class="modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h2 id="modal-title" class="modal-title">D√©tails</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body" class="modal-body">
                <!-- Contenu dynamique -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
    <script>
        // ============================================
        // üîß CONFIGURATION
        // ============================================
        const API_URL =
            window.location.hostname === "localhost" ||
                window.location.hostname === "127.0.0.1"
                ? "http://localhost:3000/api"
                : "https://en-bus-app.onrender.com/api";

        let allReservations = [];
        let allTrips = [];
        let allTemplates = [];
        let inactivityTimer;

        // ============================================
        // üîê AUTHENTIFICATION
        // ============================================
        async function verifyToken() {
            const token = localStorage.getItem("admin_token");
            if (!token) return false;

            try {
                const res = await fetch(API_URL + "/admin/verify", {
                    headers: { Authorization: `Bearer ${token}` },
                });
                return res.ok;
            } catch {
                return false;
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            try {
                const res = await fetch(API_URL + "/admin/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password }),
                });

                const data = await res.json();

                if (res.ok && data.success && data.token) { // ‚úÖ V√©rifier aussi res.ok
                    localStorage.setItem('admin_token', data.token);
                    errorDiv.classList.remove('show');
                    showNotification('Connexion r√©ussie !', 'success');
                    // ... reste de la logique de succ√®s
                    setTimeout(() => { showDashboard(); loadAdminData(); startInactivityDetection(); }, 500);
                } else {
                    // ‚úÖ AFFICHER LE MESSAGE D'ERREUR DU SERVEUR
                    const errorMessage = data.error || 'Identifiants incorrects ou erreur inconnue.';
                    errorDiv.textContent = errorMessage;
                    errorDiv.classList.add('show');
                    showNotification(errorMessage, 'error');
                }
            } catch (error) {
                showNotification("Erreur r√©seau : " + error.message, "error");
            }
        }

        function handleLogout() {
            localStorage.removeItem("admin_token");
            stopInactivityDetection();
            showNotification("D√©connexion r√©ussie", "info");
            setTimeout(showLogin, 500);
        }

        function showLogin() {
            document.getElementById("login-screen").style.display = "flex";
            document.getElementById("dashboard").classList.remove("active");
        }

        function showDashboard() {
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("dashboard").classList.add("active");
        }

        // ============================================
        // ‚è±Ô∏è INACTIVIT√â
        // ============================================
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                showNotification("Session expir√©e par inactivit√©", "warning");
                setTimeout(handleLogout, 2000);
            }, 30 * 60 * 1000);
        }

        function startInactivityDetection() {
            ["mousemove", "keypress", "click", "scroll"].forEach((event) => {
                document.addEventListener(event, resetInactivityTimer, {
                    passive: true,
                });
            });
            resetInactivityTimer();
        }

        function stopInactivityDetection() {
            clearTimeout(inactivityTimer);
            ["mousemove", "keypress", "click", "scroll"].forEach((event) => {
                document.removeEventListener(event, resetInactivityTimer);
            });
        }

        // ============================================
        // üì¢ NOTIFICATIONS
        // ============================================
        function showNotification(message, type = "info") {
            let container = document.getElementById("notification-container");
            if (!container) {
                container = document.createElement("div");
                container.id = "notification-container";
                document.body.appendChild(container);
            }

            const icons = {
                success: "‚úÖ",
                error: "‚ùå",
                warning: "‚ö†Ô∏è",
                info: "‚ÑπÔ∏è",
            };

            const notification = document.createElement("div");
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-icon">${icons[type]}</div>
                <div class="notification-content">
                    <div class="notification-message">${message}</div>
                </div>
            `;

            container.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = "slideOutRight 0.3s ease";
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // ============================================
        // üåê API CALLS
        // ============================================
        async function apiCall(endpoint, method = "GET", body = null) {
            const token = localStorage.getItem("admin_token");
            if (!token) {
                showLogin();
                return null;
            }

            try {
                const options = {
                    method,
                    headers: {
                        Authorization: `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                };

                if (body) {
                    options.headers["Content-Type"] = "application/json";
                    options.body = JSON.stringify(body);
                }

                const res = await fetch(API_URL + endpoint, options);

                if (res.status === 401 || res.status === 403) {
                    showNotification("Session expir√©e, reconnexion requise", "warning");
                    setTimeout(handleLogout, 2000);
                    return null;
                }

                const data = await res.json();

                if (!res.ok) throw new Error(data.error || "Erreur API");

                return data;
            } catch (error) {
                showNotification(error.message, "error");
                return null;
            }
        }

        // ============================================
        // üìä R√âSERVATIONS
        // ============================================
        async function loadAdminData() {
            const data = await apiCall("/admin/reservations");
            if (!data) return;

            allReservations = data.reservations;
            displayStats(data.stats);
            applyFilters();
        }

        // DANS Admin/index.html, REMPLACEZ la fonction displayStats par celle-ci

        function displayStats(stats) {
            const statsGrid = document.getElementById("stats-grid");

            // ‚úÖ CORRECTION : On s'assure que chaque valeur est un nombre avant de l'utiliser.
            // S'il est undefined, on le remplace par 0.
            const total = stats.total || 0;
            const confirmed = stats.confirmed || 0;
            const pending = stats.pending || 0;

            // On calcule le total des annul√©es en s'assurant que les deux valeurs sont des nombres.
            const totalCancelled = (stats.cancelled || 0) + (stats.expired || 0);

            statsGrid.innerHTML = `
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Total</span>
                <div class="stat-icon primary">üìä</div>
            </div>
            <div class="stat-value">${total}</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Confirm√©es</span>
                <div class="stat-icon success">‚úÖ</div>
            </div>
            <div class="stat-value">${confirmed}</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">En attente</span>
                <div class="stat-icon warning">‚è≥</div>
            </div>
            <div class="stat-value">${pending}</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <!-- On clarifie le libell√© -->
                <span class="stat-label">Annul√©es & Expir√©es</span>
                <div class="stat-icon danger">‚ùå</div>
            </div>
            <!-- On affiche le total calcul√© de mani√®re s√ªre -->
            <div class="stat-value">${totalCancelled}</div>
        </div>
    `;
        } function applyFilters() {
            let filtered = allReservations;

            // Filtre par statut (pills)
            const activeStatus = document.querySelector(".filter-pill.active")?.dataset.status;
            if (activeStatus && activeStatus !== "all") {
                filtered = filtered.filter(r => r.status === activeStatus);
            }

            // Filtre par m√©thode de paiement
            const paymentMethod = document.getElementById('filter-payment-method').value;
            if (paymentMethod !== 'all') {
                filtered = filtered.filter(r => r.paymentMethod === paymentMethod);
            }

            // Filtre par N¬∞ de Bus
            const busId = document.getElementById('filter-bus-id').value.toLowerCase().trim();
            if (busId) {
                filtered = filtered.filter(r => r.busIdentifier?.toLowerCase().includes(busId));
            }

            // Filtre par recherche g√©n√©rale
            const searchTerm = document.getElementById("search-input").value.toLowerCase().trim();
            if (searchTerm) {
                filtered = filtered.filter(r =>
                    (r.bookingNumber || '').toLowerCase().includes(searchTerm) ||
                    (r.passengers[0]?.name || '').toLowerCase().includes(searchTerm) ||
                    (r.passengers[0]?.phone || '').includes(searchTerm) ||
                    (r.paymentDetails?.transactionProof || '').toLowerCase().includes(searchTerm) ||
                    (r.agencyPaymentCode || '').toLowerCase().includes(searchTerm)
                );
            }

            renderTable(filtered);
        }
        // DANS Admin/index.html (section <script>)

        // Dans Admin/index.html - Remplacer la fonction renderTable existante

        // Dans Admin/index.html - Modifier renderTable
        // DANS Admin/index.html, REMPLACEZ votre fonction renderTable par celle-ci
        // DANS Admin/index.html, REMPLACEZ votre fonction renderTable par celle-ci

        // DANS Admin/index.html, REMPLACEZ la fonction renderTable par celle-ci

        // DANS Admin/index.html, REMPLACEZ la fonction renderTable

        // DANS Admin/index.html, REMPLACEZ la fonction renderTable
        function renderTable(reservations) {
            const tbody = document.getElementById('reservations-body');
            if (!tbody) {
                console.error("‚ùå √âl√©ment 'reservations-body' introuvable !");
                return;
            }

            if (!reservations || reservations.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center" style="padding:3rem;">Aucune r√©servation ne correspond √† vos filtres.</td></tr>`;
                return;
            }

            tbody.innerHTML = reservations.map(r => {
                const p = r.passengers?.[0] || {};
                const statusMap = { 'Confirm√©': 'success', 'En attente de paiement': 'warning', 'Annul√©': 'danger', 'Expir√©': 'gray', 'En attente de report': 'warning' };
                const badgeClass = `badge-${statusMap[r.status] || 'gray'}`;

                // ==========================================================
                // ‚úÖ CORRECTION DE LA LOGIQUE D'AFFICHAGE DE LA PREUVE
                // ==========================================================
                const proof =
                    r.paymentDetails?.transactionProof ||       // 1. Preuve valid√©e par l'admin
                    r.paymentDetails?.clientTransactionId ||  // 2. Preuve soumise par le client
                    r.agencyPaymentCode ||                    // 3. Code de paiement agence
                    'N/A';                                    // 4. Si rien n'est trouv√©
                // ==========================================================

                const method = r.paymentMethod || 'N/A';

                let countdownHTML = '';
                if (r.status === 'En attente de paiement' && r.paymentDeadline) {
                    countdownHTML = `
                <div class="payment-countdown mt-1" data-deadline="${r.paymentDeadline}">
                    <span class="countdown-icon">‚è±Ô∏è</span>
                    <span class="countdown-time">Calcul...</span>
                </div>
            `;
                }

                return `
            <tr>
                <td><strong class="font-mono">${r.bookingNumber}</strong></td>
                <td>
                    ${new Date(r.date).toLocaleDateString('fr-FR')}<br>
                    <strong class="text-xs" style="color: var(--accent);">Bus: ${r.busIdentifier || 'N/A'}</strong>
                </td>
                <td>${r.route.from} ‚Üí ${r.route.to}</td>
                <td>
                    <div class="font-bold">${p.name || 'N/A'}</div>
                    <div class="text-xs text-muted">${p.phone || 'N/A'}</div>
                </td>
                <td>
                    <div class="font-bold">${r.totalPrice}</div>
                    <div class="text-xs text-muted" style="margin-top: 4px;">
                        Preuve: <span class="font-mono" style="color: white; background: var(--dark-elevated); padding: 2px 4px; border-radius: 4px;">${proof}</span>
                        (${method})
                    </div>
                </td>
                <td>
                    <span class="badge ${badgeClass}">${r.status}</span>
                    ${countdownHTML} 
                </td>
                <td class="actions-cell">
                    <button class="btn btn-icon btn-ghost" onclick="showDetails('${r._id}')" title="D√©tails">üìã</button>
                    ${r.status === 'En attente de paiement' ? `<button class="btn btn-icon btn-success" onclick="performAction('${r._id}', 'confirm-payment')">‚úÖ</button>` : ''}
                    <button class="btn btn-icon btn-ghost" onclick="showChangeSeatsModal('${r._id}')">üí∫</button>
                    ${r.status !== 'Annul√©' && r.status !== 'Expir√©' ? `<button class="btn btn-icon btn-danger" onclick="performAction('${r._id}', 'cancel')">‚ùå</button>` : ''}
                </td>
            </tr>
        `;
            }).join('');

            startCountdownUpdates();
        }
        // Dans Admin/index.html - Ajouter apr√®s renderTable()

        // ============================================
        // ‚è±Ô∏è MISE √Ä JOUR DES CHRONOM√àTRES EN TEMPS R√âEL
        // ============================================

        let countdownInterval = null;
        // DANS Admin/index.html, REMPLACEZ la fonction startCountdownUpdates par celle-ci

        function startCountdownUpdates() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            countdownInterval = setInterval(() => {
                const countdowns = document.querySelectorAll('.payment-countdown[data-deadline]');

                countdowns.forEach(countdown => {
                    const deadline = new Date(countdown.dataset.deadline);
                    const now = new Date();
                    const timeLeft = deadline - now;

                    // ‚úÖ S√âCURIT√â : Cibler les bons sous-√©l√©ments
                    const timeElement = countdown.querySelector('.countdown-time');
                    const iconElement = countdown.querySelector('.countdown-icon');

                    if (!timeElement || !iconElement) return; // Si les √©l√©ments n'existent pas, on arr√™te

                    if (timeLeft > 0) {
                        const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                        timeElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                        countdown.classList.remove('normal', 'warning', 'urgent');

                        if (hours < 1) {
                            countdown.classList.add('urgent');
                            iconElement.textContent = 'üö®';
                        } else if (hours < 3) {
                            countdown.classList.add('warning');
                            iconElement.textContent = '‚ö†Ô∏è';
                        } else {
                            countdown.classList.add('normal');
                            iconElement.textContent = '‚è±Ô∏è';
                        }

                    } else {
                        timeElement.textContent = 'EXPIR√â';
                        iconElement.textContent = '‚ùå';
                        countdown.classList.remove('normal', 'warning');
                        countdown.classList.add('urgent');
                    }
                });

            }, 1000);
        }

        // Arr√™ter les mises √† jour quand on quitte la page des r√©servations
        function stopCountdownUpdates() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }
        // ============================================
        // üéØ ACTIONS SUR LES R√âSERVATIONS
        // ============================================
        // ============================================
        // üéØ ACTIONS SUR LES R√âSERVATIONS
        // ============================================

        // DANS Admin/index.html, REMPLACEZ la fonction performAction

        // DANS Admin/index.html, REMPLACEZ la fonction performAction

        // DANS Admin/index.html, REMPLACEZ la fonction performAction

        async function performAction(reservationId, action) {
            // ‚úÖ CORRECTION : Fermer toute modale existante avant de commencer
            closeAllModals();

            // Petit d√©lai pour laisser le navigateur rafra√Æchir l'affichage
            await new Promise(resolve => setTimeout(resolve, 50));

            const reservation = allReservations.find(r => r._id === reservationId);
            if (!reservation) {
                showNotification("Erreur: R√©servation introuvable.", "error");
                return;
            }

            if (action === 'confirm-payment') {
                const transactionProof = await showAdminInputModal({
                    title: 'Confirmer le Paiement',
                    message: `Saisissez la preuve de transaction (ID, r√©f, etc.) pour la r√©servation ${reservation.bookingNumber}.`,
                    icon: 'üßæ',
                    iconClass: 'success',
                    label: 'ID de Transaction ou R√©f√©rence',
                    confirmText: 'Valider le Paiement'
                });

                if (transactionProof === null) return; // L'utilisateur a annul√©

                const data = await apiCall(`/admin/reservations/${reservationId}/${action}`, 'PATCH', { transactionProof });
                if (data && data.success) {
                    showNotification('Paiement confirm√© avec succ√®s !', 'success');
                    loadAdminData();
                }

            } else if (action === 'cancel') {
                const confirmed = await showAdminConfirm({
                    title: 'Annuler la R√©servation ?',
                    message: `ATTENTION : Annuler la r√©servation ${reservation.bookingNumber} lib√©rera les si√®ges.\nCette action est irr√©versible.`,
                    icon: 'üóëÔ∏è',
                    iconClass: 'danger',
                    confirmText: 'Oui, annuler'
                });

                if (confirmed) {
                    const data = await apiCall(`/admin/reservations/${reservationId}/${action}`, 'PATCH');
                    if (data && data.success) {
                        showNotification('R√©servation annul√©e.', 'success');
                        loadAdminData();
                    }
                }
            }
        }
        // Dans Admin/index.html (section <script>)
        // Dans Admin/index.html - Remplacer showDetails existante

        // ============================================
        // üîÑ FORCER LE CHARGEMENT AU D√âMARRAGE
        // ============================================
        document.addEventListener("DOMContentLoaded", async () => {
            console.log("üöÄ Chargement de la page admin...");

            if (await verifyToken()) {
                console.log("‚úÖ Token valide, chargement des donn√©es...");
                showDashboard();
                await loadAdminData(); // ‚úÖ FORCER LE CHARGEMENT
                startInactivityDetection();
            } else {
                console.log("‚ùå Token invalide, affichage du login");
                localStorage.removeItem("admin_token");
                showLogin();
            }

            setupEventListeners();
            buildDaysSelector();

            flatpickr("#trip-dates", {
                mode: "range",
                dateFormat: "Y-m-d",
                locale: "fr",
                minDate: "today",
            });
        });

        function showDetails(reservationId) {
            const r = allReservations.find((res) => res._id === reservationId);
            if (!r) {
                showNotification(
                    "Erreur : Impossible de trouver les d√©tails de cette r√©servation.",
                    "error"
                );
                return;
            }

            document.getElementById(
                "modal-title"
            ).textContent = `D√©tails - ${r.bookingNumber}`;

            // ‚úÖ SECTION PAIEMENT EN AGENCE SI APPLICABLE
            let paymentInfoHTML = "";
            if (
                r.status === "En attente de paiement" &&
                r.paymentDeadline &&
                r.agency
            ) {
                const deadline = new Date(r.paymentDeadline);
                const now = new Date();
                const timeLeft = deadline - now;

                if (timeLeft > 0) {
                    const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
                    const minutesLeft = Math.floor(
                        (timeLeft % (1000 * 60 * 60)) / (1000 * 60)
                    );

                    paymentInfoHTML = `
                <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe7a1 100%); border-left: 5px solid #ff9800; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #e65100; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">‚è∞</span>
                        Paiement requis √† l'agence
                    </h4>
                    <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 5px;">TEMPS RESTANT</div>
                        <div style="font-size: 28px; font-weight: 900; color: #d32f2f; font-family: var(--font-mono);">
                            ${hoursLeft}h ${minutesLeft}min
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            Deadline : ${deadline.toLocaleString("fr-FR")}
                        </div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 6px;">
                        <div style="font-weight: 700; margin-bottom: 8px;">üìç ${r.agency.name
                        }</div>
                        <div style="font-size: 13px; color: #666; line-height: 1.6;">
                            ${r.agency.address}<br>
                            üìû ${r.agency.phone}<br>
                            üïê ${r.agency.hours}
                        </div>
                    </div>
                </div>
            `;
                } else {
                    paymentInfoHTML = `
                <div style="background: #ffebee; border-left: 5px solid #ef5350; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0; color: #c62828; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">‚ùå</span>
                        D√©lai de paiement d√©pass√© - Cette r√©servation sera bient√¥t expir√©e
                    </h4>
                </div>
            `;
                }
            }

            document.getElementById("modal-body").innerHTML = `
        ${paymentInfoHTML}
        
        <h4 style="font-weight: 700; margin-bottom: 15px; color: var(--primary);">üë• Passagers</h4>
        <ul style="list-style-type: none; padding: 0; margin-bottom: 20px;">
            ${r.passengers
                    .map(
                        (p) => `
                <li style="padding: 12px; border-bottom: 1px solid var(--dark-border); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${p.name}</strong><br>
                        <span style="font-size: 13px; color: var(--text-muted);">${p.phone}</span>
                    </div>
                    <span style="background: var(--dark-elevated); padding: 4px 12px; border-radius: 6px; font-weight: 700;">
                        üí∫ ${p.seat}
                    </span>
                </li>
            `
                    )
                    .join("")}
        </ul>
        
        <hr style="margin: 20px 0; border-color: var(--dark-border);">
        
        <h4 style="font-weight: 700; margin-bottom: 15px; color: var(--primary);">üí∞ Paiement</h4>
        <div style="background: var(--dark-elevated); padding: 15px; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>M√©thode :</span>
                <strong>${r.paymentMethod || "N/A"}</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Total :</span>
                <strong style="color: var(--primary); font-size: 18px;">${r.totalPrice
                }</strong>
            </div>
        </div>
    `;

            document.getElementById("details-modal").classList.add("active");
        }

        // DANS Admin/index.html, REMPLACEZ la fonction closeModal

        // Nouvelle fonction "ma√Ætresse" pour tout fermer
        function closeAllModals() {
            document.getElementById('details-modal').classList.remove('active');
            document.getElementById('input-modal').style.display = 'none'; // Assurez-vous que les deux sont g√©r√©es

            // Une m√©thode encore plus g√©n√©rique si vous ajoutez d'autres modales plus tard :
            // document.querySelectorAll('.custom-modal-overlay').forEach(modal => {
            //     modal.style.display = 'none';
            //     modal.classList.remove('active');
            // });
        }

        // L'ancienne fonction closeModal appelle maintenant la nouvelle
        function closeModal() {
            closeAllModals();
        }
        // ============================================
        // üó∫Ô∏è MOD√àLES
        // ============================================
        async function loadAllTemplates() {
            const data = await apiCall("/admin/route-templates");
            if (!data) return;

            allTemplates = data.templates;
            renderTemplatesTable();
            populateRouteTemplateSelector();
        }

        function renderTemplatesTable() {
            const tbody = document.getElementById("templates-body");

            if (allTemplates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center" style="padding:3rem;">
                            <div style="font-size:3rem;margin-bottom:1rem;">üõ£Ô∏è</div>
                            <div style="color:var(--gray-500);font-weight:600;">Aucun mod√®le de trajet</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = allTemplates
                .map(
                    (t) => `
                <tr>
                    <td>
                        <div class="font-bold">${t.from} ‚Üí ${t.to}</div>
                    </td>
                    <td>${t.company}</td>
                    <td class="font-bold">${t.price} FCFA</td>
                    <td class="text-sm">
                        <span style="color:var(--gray-600);">üïê ${t.departure} ‚Üí ${t.arrival}</span>
                    </td>
                    <td>
                        <!-- ‚úÖ AJOUT DU BOUTON MODIFIER -->
                <button class="btn btn-sm btn-ghost" onclick="showEditTemplateModal('${t._id}')">‚úèÔ∏è Modifier</button>

                        <button class="btn btn-sm btn-danger" onclick="handleDeleteTemplate('${t._id}', '${t.from} ‚Üí ${t.to}')">
                            üóëÔ∏è Supprimer
                        </button>
                    </td>
                </tr>
            `
                )
                .join("");
        }

        // Dans Admin/index.html (section <script>)
        async function handleCreateTemplate(e) {
            e.preventDefault();

            const amenities = Array.from(
                document.querySelectorAll('input[name="amenity"]:checked')
            ).map((cb) => cb.value);
            const tripType = document.getElementById("template-trip-type").value;

            const stops = Array.from(document.querySelectorAll(".stop-item")).map(
                (stopDiv) => ({
                    city: stopDiv.querySelector(".stop-city").value,
                    arrivalTime: stopDiv.querySelector(".stop-arrival").value,
                    departureTime: stopDiv.querySelector(".stop-departure").value,
                    duration: stopDiv.querySelector(".stop-duration").value,
                })
            );

            // ‚úÖ R√âCUP√âRER LES CORRESPONDANCES AVEC LES NOUVEAUX CHAMPS
            const connections = Array.from(
                document.querySelectorAll(".connection-item")
            ).map((connDiv) => ({
                at: connDiv.querySelector(".conn-city").value,
                arrivalTime: connDiv.querySelector(".conn-arrival").value,
                waitTime: connDiv.querySelector(".conn-wait").value,
                nextDeparture: connDiv.querySelector(".conn-next-departure").value, // Ajout√©
                nextCompany: connDiv.querySelector(".conn-next-company").value, // Ajout√©
                nextBusNumber: connDiv.querySelector(".conn-next-bus-number").value, // Ajout√©
            }));

            const newTemplate = {
                from: document.getElementById("template-from").value.trim(),
                // ‚úÖ AJOUTER CETTE LIGNE
                departureLocation: document.getElementById('template-departure-location').value.trim(),

                to: document.getElementById("template-to").value.trim(),

                // ‚úÖ AJOUTER CETTE LIGNE
                arrivalLocation: document.getElementById('template-arrival-location').value.trim(),

                company: document.getElementById("template-company").value.trim(),
                price: parseInt(document.getElementById("template-price").value),
                departure: document.getElementById("template-departure").value,
                arrival: document.getElementById("template-arrival").value,
                amenities: amenities,
                tripType: tripType,
                stops: stops,
                connections: connections,
                breaks: stops.length,

                // ‚úÖ ENVOYER LES DONN√âES BRUTES DES BAGAGES
                standardBaggageIncluded: document.getElementById(
                    "standard-baggage-included"
                ).value,
                standardBaggageMax: document.getElementById("standard-baggage-max")
                    .value,
                standardBaggagePrice: document.getElementById(
                    "standard-baggage-price"
                ).value,
                oversizedBaggageMax: document.getElementById("oversized-baggage-max")
                    .value,
                oversizedBaggagePrice: document.getElementById(
                    "oversized-baggage-price"
                ).value,
            };

            const data = await apiCall(
                "/admin/route-templates",
                "POST",
                newTemplate
            );

            if (data) {
                showNotification("Mod√®le cr√©√© avec succ√®s", "success");
                e.target.reset();
                document.getElementById("stops-container").innerHTML = "";
                document.getElementById("connections-container").innerHTML = "";
                toggleTripOptions();
                loadAllTemplates();
            }
        }
        // DANS Admin/index.html, REMPLACEZ la fonction handleDeleteTemplate par celle-ci

        async function handleDeleteTemplate(templateId, templateName) {
            // Utilisation de la nouvelle modale personnalis√©e au lieu de confirm()
            const confirmed = await showAdminConfirm({
                title: "Supprimer le Mod√®le ?",
                message: `Voulez-vous vraiment supprimer le mod√®le de trajet "${templateName}" ?\n\nCette action est irr√©versible et ne peut pas √™tre annul√©e.`,
                icon: 'üóëÔ∏è',
                iconClass: 'danger',
                confirmText: 'Oui, supprimer',
                confirmClass: 'btn-danger'
            });

            // Si l'utilisateur clique sur "Annuler" dans la modale, on arr√™te la fonction ici.
            if (!confirmed) {
                return;
            }

            // Si la confirmation est donn√©e, on proc√®de √† l'appel API
            const data = await apiCall(
                `/admin/route-templates/${templateId}`,
                "DELETE"
            );

            if (data && data.success) {
                showNotification("Mod√®le supprim√© avec succ√®s", "success");
                loadAllTemplates();
            }
            // La gestion d'erreur est d√©j√† g√©r√©e √† l'int√©rieur de apiCall()
        }

        function populateRouteTemplateSelector() {
            const select = document.getElementById("route-template");

            if (allTemplates.length === 0) {
                select.innerHTML =
                    '<option value="">Cr√©ez un mod√®le d\'abord</option>';
            } else {
                select.innerHTML =
                    '<option value="">S√©lectionnez un mod√®le</option>' +
                    allTemplates
                        .map(
                            (t) => `
                        <option value="${t._id}">${t.from} ‚Üí ${t.to} (${t.company})</option>
                    `
                        )
                        .join("");
            }
        }

        // ============================================
        // üöå VOYAGES
        // ============================================
        async function loadAllTrips() {
            // 1. R√©cup√©rer les valeurs des champs de filtre
            const dateFilter = document.getElementById('trip-filter-date')?.value || '';
            const routeFilter = document.getElementById('trip-filter-route')?.value || '';
            const busFilter = document.getElementById('trip-filter-bus')?.value || '';

            // 2. Construire une cha√Æne de param√®tres pour l'URL
            const params = new URLSearchParams();
            if (dateFilter) {
                params.append('date', dateFilter);
            }
            if (routeFilter) {
                params.append('route', routeFilter);
            }
            if (busFilter) {
                params.append('bus', busFilter);
            }

            // On convertit les param√®tres en une cha√Æne de requ√™te (ex: "?date=2025-11-28&route=Brazza")
            const queryString = params.toString();
            const endpoint = `/admin/trips${queryString ? '?' + queryString : ''}`;

            console.log(`Chargement des voyages depuis : ${endpoint}`);

            // 3. Appeler l'API avec le bon endpoint
            const data = await apiCall(endpoint);
            if (!data) {
                // En cas d'erreur, on vide la table pour √©viter d'afficher d'anciens r√©sultats
                allTrips = [];
                renderTripsTable();
                return;
            }

            allTrips = data.trips;
            renderTripsTable(); // Affiche les voyages filtr√©s
        }

        // Dans Admin/index.html (section <script>)
        // DANS admin/index.html, dans <script>

        // DANS admin/index.html, dans <script>
        // DANS admin/index.html, dans <script>
        // DANS admin/index.html, REMPLACEZ votre fonction renderTripsTable par celle-ci

        function renderTripsTable() {
            const tbody = document.getElementById("trips-body");

            if (allTrips.length === 0) {
                tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center" style="padding:3rem;">
                    <div style="font-size:3rem;margin-bottom:1rem;">üöå</div>
                    <div style="color:var(--text-muted);font-weight:600;">Aucun voyage programm√©</div>
                </td>
            </tr>
        `;
                return;
            }

            // On g√©n√®re le HTML en utilisant des attributs `data-*` pour stocker les informations
            tbody.innerHTML = allTrips.map((trip) => {
                const availableSeats = trip.seats.filter(s => s.status === "available").length;
                const occupiedSeats = trip.seats.filter(s => s.status === "occupied").length;
                const percentage = (availableSeats / trip.seats.length) * 100;
                const canBeDeleted = occupiedSeats === 0;

                // On pr√©pare le bouton de suppression
                const deleteButtonHTML = canBeDeleted
                    ? `<button class="btn btn-icon btn-danger" onclick="deleteTrip('${trip._id}')" title="Supprimer le voyage">üóëÔ∏è</button>`
                    : `<button class="btn btn-icon btn-ghost" disabled title="Impossible de supprimer : des r√©servations sont actives" style="opacity:0.3;cursor:not-allowed;">üîí</button>`;

                // On retourne la ligne compl√®te du tableau
                return `
            <tr>
                <td class="font-bold">${new Date(trip.date).toLocaleDateString("fr-FR", {
                    weekday: "short",
                    day: "2-digit",
                    month: "short",
                    year: "numeric",
                })}</td>
                <td>
                    <div class="font-bold">${trip.route.from} ‚Üí ${trip.route.to}</div>
                    <div class="text-xs" style="color:var(--text-muted);">üïê ${trip.route.departure} ‚Ä¢ ${trip.route.price} FCFA</div>
                </td>
                <td>${trip.route.company}</td>
                <td class="font-bold font-mono" style="color: var(--primary);">${trip.busIdentifier || "N/A"}</td>
                <td>
                    <div style="display:flex;align-items:center;gap:var(--spacing-sm);">
                        <div style="flex:1;background:var(--dark-elevated);height:8px;border-radius:9999px;overflow:hidden;">
                            <div style="width:${percentage}%;height:100%;background:${percentage > 50 ? "var(--primary)" :
                        percentage > 20 ? "var(--status-pending)" :
                            "var(--status-cancelled)"
                    };transition:width 0.3s;"></div>
                        </div>
                        <span class="font-bold text-sm">${availableSeats}/${trip.seats.length}</span>
                    </div>
                    ${occupiedSeats > 0 ? `<div class="text-xs" style="color:var(--status-confirmed);margin-top:4px;">‚úÖ ${occupiedSeats} r√©serv√©(s)</div>` : ""}
                </td>
             

<td>
    <div class="actions-cell">
        <!-- ‚úÖ CORRECTION : Retour aux onclick directs pour plus de fiabilit√© -->
        <button class="btn btn-icon btn-ghost" onclick="manageSeats('${trip._id}')" title="G√©rer si√®ges">üí∫</button>
        <button class="btn btn-icon btn-ghost" onclick="showEditTripModal('${trip._id}')" title="Modifier le voyage">‚úèÔ∏è</button>
        <!-- ‚úÖ NOUVEAU BOUTON -->
    <button class="btn btn-icon btn-ghost" style="color: #2196f3;" 
            onclick="openStatusModal('${trip._id}', '${trip.route.from} ‚Üí ${trip.route.to}')" 
            title="Mettre √† jour le statut">
        üì¢
    </button>
        <button class="btn btn-icon btn-ghost" style="color: var(--status-pending);" onclick="resetTripSeats('${trip._id}')" title="R√©initialiser tous les si√®ges">üîÑ</button>
        ${deleteButtonHTML}
    </div>
</td>
            </tr>
        `;
            }).join("");

            // NOTE : La partie qui attache les `addEventListener` a √©t√© d√©plac√©e 
            // dans la fonction setupEventListeners pour √™tre appel√©e une seule fois.
        }
        // Dans Admin/index.html (section <script>)
        // DANS Admin/index.html, REMPLACEZ la fonction handleCreateTrips

        async function handleCreateTrips(e) {
            e.preventDefault();

            // 1. R√©cup√©ration des valeurs du formulaire
            const routeId = document.getElementById("route-template").value;
            const dateValue = document.getElementById("trip-dates").value;
            const seatCount = parseInt(document.getElementById("seat-count").value);
            const busIdentifier = document.getElementById("bus-identifier").value.trim();
            const highlightBadge = document.getElementById('highlight-badge').value.trim();

            // 2. Validations
            if (!routeId) {
                showNotification("Veuillez s√©lectionner un mod√®le de trajet.", "warning");
                return;
            }
            if (!dateValue) {
                showNotification("Veuillez s√©lectionner une ou plusieurs dates.", "warning");
                return;
            }
            if (!seatCount || seatCount < 10 || seatCount > 100) {
                showNotification("Le nombre de si√®ges doit √™tre entre 10 et 100.", "warning");
                return;
            }

            // 3. Logique des dates et jours
            let startDate, endDate;
            if (dateValue.includes(" au ")) {
                [startDate, endDate] = dateValue.split(" au ");
            } else {
                startDate = endDate = dateValue;
            }

            const selectedDays = Array.from(
                document.querySelectorAll("#days-selector input:checked")
            ).map((cb) => cb.value);

            if (selectedDays.length === 0 && startDate !== endDate) {
                showNotification("Veuillez s√©lectionner au moins un jour pour une plage de dates.", "warning");
                return;
            }

            // Si une seule date est choisie, on consid√®re que tous les jours sont valides pour ce jour unique.
            const daysToSend = (startDate === endDate)
                ? ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"]
                : selectedDays;

            // 4. Construction de l'objet de donn√©es pour l'API
            const tripData = {
                routeId,
                startDate,
                endDate,
                daysOfWeek: daysToSend,
                seatCount,
                busIdentifier: busIdentifier || null,
                highlightBadge: highlightBadge || null // Envoie null si le champ est vide
            };

            console.log("üì§ Envoi des donn√©es de cr√©ation de voyage :", tripData);

            // 5. Appel API
            const data = await apiCall("/admin/trips", "POST", tripData);

            // 6. Gestion du r√©sultat
            if (data && data.success) {
                showNotification(data.message || "Voyages programm√©s avec succ√®s !", "success");
                e.target.reset(); // R√©initialise le formulaire
                loadAllTrips();   // Met √† jour le tableau des voyages
            }
            // La gestion d'erreur est d√©j√† dans apiCall()
        }
        // Dans Admin/index.html (section <script>)
        function manageSeats(tripId) {
            const trip = allTrips.find((t) => t._id === tripId);
            if (!trip) {
                showNotification("Erreur : Le voyage n'a pas √©t√© trouv√©.", "error");
                return;
            }

            const modalTitle = document.getElementById("modal-title");
            const modalBody = document.getElementById("modal-body");

            modalTitle.textContent = `Gestion des si√®ges - ${trip.route.from} ‚Üí ${trip.route.to
                } (${new Date(trip.date).toLocaleDateString("fr-FR")})`;

            let seatMapHTML =
                '<div class="seat-map-container"><div class="seat-map">';

            trip.seats.forEach((seat, index) => {
                const seatClass = `seat seat-${seat.status}`;

                // ‚úÖ CORRECTION : ON AJOUTE TOUJOURS L'ATTRIBUT ONCLICK
                const onClick = `onclick="toggleSeatStatus('${trip._id}', ${seat.number}, '${seat.status}')"`;

                seatMapHTML += `<div class="${seatClass}" ${onClick} title="Si√®ge ${seat.number}: ${seat.status}">${seat.number}</div>`;

                if ((index + 1) % 2 === 0 && (index + 1) % 4 !== 0) {
                    seatMapHTML += '<div class="seat-aisle"></div>';
                }
            });

            seatMapHTML += `</div></div>`;

            modalBody.innerHTML = `
        <p>Cliquez sur un si√®ge pour changer son statut (Disponible ‚Üî Bloqu√©) ou pour lib√©rer un si√®ge occup√©.</p>
        ${seatMapHTML}
        <div class="seat-legend">
            <div class="legend-item">
                <div class="legend-box" style="background:var(--primary);"></div>
                <span>Disponible</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background:#ef5350;"></div>
                <span>Occup√©</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background:var(--dark-border);"></div>
                <span>Bloqu√©</span>
            </div>
        </div>
    `;

            document.getElementById("details-modal").classList.add("active");
        }

        // Dans Admin/index.html (section <script>)
        // Dans Admin/index.html (section <script>)
        // DANS Admin/index.html, REMPLACEZ la fonction toggleSeatStatus

        async function toggleSeatStatus(tripId, seatNumber, currentStatus) {
            // Le "alert()" de d√©bogage est supprim√©.

            let newStatus;

            // Logique de changement de statut
            if (currentStatus === 'available') {
                newStatus = 'blocked';
            } else if (currentStatus === 'blocked') {
                newStatus = 'available';
            } else if (currentStatus === 'occupied') {
                // ‚úÖ Utilisation de la modale personnalis√©e pour l'avertissement
                const confirmed = await showAdminConfirm({
                    title: "Lib√©rer un si√®ge r√©serv√© ?",
                    message: `ATTENTION : Le si√®ge ${seatNumber} est d√©j√† r√©serv√© par un client.\n\nForcer sa lib√©ration annulera sa place sur ce trajet. √ätes-vous s√ªr de vouloir continuer ?`,
                    icon: '‚ö†Ô∏è',
                    iconClass: 'warning',
                    confirmText: 'Oui, lib√©rer',
                    confirmClass: 'btn-danger'
                });

                if (!confirmed) {
                    return; // L'admin annule l'op√©ration
                }
                newStatus = 'available';
            } else {
                return; // Ne rien faire pour les statuts inconnus
            }

            // Appel √† l'API pour mettre √† jour le statut en base de donn√©es
            const data = await apiCall(`/admin/trips/${tripId}/seats/${seatNumber}`, 'PATCH', { status: newStatus });

            if (data && data.success) {
                // Mettre √† jour l'√©tat local pour un rafra√Æchissement imm√©diat
                const trip = allTrips.find(t => t._id === tripId);
                if (trip) {
                    const seat = trip.seats.find(s => s.number === seatNumber);
                    if (seat) {
                        seat.status = newStatus;
                    }
                }

                showNotification(data.message || `Si√®ge ${seatNumber} mis √† jour.`, 'success');
                manageSeats(tripId); // Rafra√Æchit la modale pour afficher le nouvel √©tat
            }
        }




        function openStatusModal(tripId, tripName) {
            const modalTitle = document.getElementById("modal-title");
            const modalBody = document.getElementById("modal-body");

            modalTitle.textContent = "Mettre √† jour le statut du voyage";
            modalBody.innerHTML = `
        <p>Voyage : <strong>${tripName}</strong></p>
        <form id="status-form">
            <div class="form-group" style="margin-top: 20px;">
                <label for="status-select" class="form-label">Nouveau Statut</label>
                <select id="status-select" class="form-control">
                    <option value="ON_TIME">‚úÖ √Ä l'heure</option>
                    <option value="DELAYED">üü† En retard</option>
                    <option value="CANCELLED">üî¥ Annul√©</option>
                    <option value="ARRIVED">üèÅ Arriv√©</option>
                </select>
            </div>
            <div id="delay-details" style="display:none;">
                <div class="form-group">
                    <label for="delay-minutes" class="form-label">Dur√©e du retard (minutes)</label>
                    <input type="number" id="delay-minutes" class="form-control" min="5" step="5">
                </div>
                <div class="form-group">
                    <label for="delay-reason" class="form-label">Raison (optionnel)</label>
                    <input type="text" id="delay-reason" class="form-control" placeholder="Ex: Trafic dense">
                </div>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button type="button" class="btn btn-ghost" onclick="closeModal()">Annuler</button>
                <button type="submit" class="btn btn-primary">Mettre √† jour</button>
            </div>
        </form>
    `;

            const statusSelect = document.getElementById('status-select');
            const delayDetails = document.getElementById('delay-details');
            statusSelect.onchange = () => {
                delayDetails.style.display = statusSelect.value === 'DELAYED' ? 'block' : 'none';
            };

            document.getElementById("status-form").addEventListener('submit', (e) => {
                e.preventDefault();
                const status = statusSelect.value;
                const delayMinutes = document.getElementById('delay-minutes').value;
                const reason = document.getElementById('delay-reason').value;

                // Pour un voyage annul√©, la raison devient obligatoire
                if (status === 'CANCELLED' && !reason) {
                    showNotification('Veuillez sp√©cifier la raison de l\'annulation.', 'warning');
                    return;
                }

                updateTripStatus(tripId, status, delayMinutes, reason);
            });

            document.getElementById("details-modal").classList.add('active');
        }

        async function updateTripStatus(tripId, status, delayMinutes, reason) {
            showNotification('Mise √† jour du statut en cours...', 'info');

            const body = { status, delayMinutes: parseInt(delayMinutes), reason };

            const data = await apiCall(`/admin/trips/${tripId}/status`, 'PATCH', body);

            if (data && data.success) {
                showNotification(data.message, 'success');
                closeModal();
            }
        }
        // ============================================
        // ‚úèÔ∏è MODIFICATION ET SUPPRESSION DE VOYAGE
        // ============================================

        function showEditTripModal(tripId) {
            const trip = allTrips.find((t) => t._id === tripId);
            if (!trip) return;

            const occupiedSeatsCount = trip.seats.filter(
                (s) => s.status === "occupied"
            ).length;
            const allAmenities = ["wifi", "wc", "clim", "prise"];

            document.getElementById(
                "modal-title"
            ).textContent = `Modifier le voyage : ${trip.route.from} ‚Üí ${trip.route.to}`;

            // ‚úÖ CONSTRUCTION DU HTML DE LA MODALE (avec tous les champs)
            document.getElementById("modal-body").innerHTML = `
        <form id="edit-trip-form" style="display:grid;gap:var(--spacing-lg);">
            
            <!-- Champ DATE -->
            <div class="form-group">
                <label for="edit-trip-date" class="form-label">Date du voyage</label>
                <input 
                    type="date" 
                    id="edit-trip-date" 
                    class="form-control" 
                    value="${new Date(trip.date).toISOString().split("T")[0]}"
                    required
                >
            </div>
            
            <!-- Champ SI√àGES -->
            <div class="form-group">
                <label for="edit-trip-seats" class="form-label">Nombre total de si√®ges</label>
                <input 
                    type="number" 
                    id="edit-trip-seats" 
                    class="form-control" 
                    value="${trip.seats.length}"
                    min="${occupiedSeatsCount}"
                    max="100"
                    required
                >
                <small style="color:var(--text-muted);font-size:0.75rem;margin-top:4px;display:block;">
                    ${occupiedSeatsCount > 0
                    ? `‚ö†Ô∏è Min: ${occupiedSeatsCount} (si√®ges r√©serv√©s)`
                    : "Entre 10 et 100"
                }
                </small>
            </div>
            
            <!-- Champ √âQUIPEMENTS -->
            <div class="form-group form-group-full">
                <label class="form-label">√âquipements</label>
                <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                    ${allAmenities
                    .map(
                        (amenity) => `
                        <label class="amenity-checkbox-label">
                            <input type="checkbox" name="edit-amenity" value="${amenity}" 
                                ${trip.route.amenities?.includes(amenity)
                                ? "checked"
                                : ""
                            }>
                            <span>${amenity.charAt(0).toUpperCase() + amenity.slice(1)
                            }</span>
                        </label>
                    `
                    )
                    .join("")}
                </div>
            </div>
            
            <!-- Boutons d'action -->
            <div style="display:flex;gap:var(--spacing-md);justify-content:flex-end;padding-top:var(--spacing-md);border-top:1px solid var(--dark-border);">
                <button type="button" class="btn btn-ghost" onclick="closeModal()">Annuler</button>
                <button type="submit" class="btn btn-primary">üíæ Enregistrer</button>
            </div>
        </form>
    `;

            // Attacher l'√©v√©nement de soumission au formulaire
            document
                .getElementById("edit-trip-form")
                .addEventListener("submit", async (e) => {
                    e.preventDefault();

                    // R√©cup√©rer les nouvelles valeurs
                    const newDate = document.getElementById("edit-trip-date").value;
                    const newSeatCount = parseInt(
                        document.getElementById("edit-trip-seats").value
                    );
                    const newAmenities = Array.from(
                        document.querySelectorAll('input[name="edit-amenity"]:checked')
                    ).map((cb) => cb.value);

                    // Construire l'objet 'updates'
                    const updates = {};
                    let hasChanges = false;

                    // Comparer la date
                    if (newDate !== new Date(trip.date).toISOString().split("T")[0]) {
                        updates.date = newDate;
                        hasChanges = true;
                    }

                    // Comparer le nombre de si√®ges
                    if (newSeatCount !== trip.seats.length) {
                        updates.seatCount = newSeatCount;
                        hasChanges = true;
                    }

                    // Comparer les √©quipements
                    const currentAmenities = trip.route.amenities || [];
                    if (
                        JSON.stringify(newAmenities.sort()) !==
                        JSON.stringify(currentAmenities.sort())
                    ) {
                        updates["route.amenities"] = newAmenities; // Utiliser la notation point√©e
                        hasChanges = true;
                    }

                    // Si aucun changement, ne pas envoyer de requ√™te
                    if (!hasChanges) {
                        showNotification("Aucune modification d√©tect√©e.", "info");
                        closeModal();
                        return;
                    }

                    // Envoyer la requ√™te API
                    const data = await apiCall(
                        `/admin/trips/${tripId}`,
                        "PATCH",
                        updates
                    );

                    if (data) {
                        showNotification(data.message, "success");
                        closeModal();
                        loadAllTrips(); // Recharger la liste pour voir les changements
                    }
                });

            document.getElementById("details-modal").classList.add("active");
        }
        // DANS admin/index.html, dans la balise <script>

        // DANS admin/index.html, dans la balise <script>

        async function deleteTrip(tripId) {
            console.log(`üîç V√©rification du statut pour : ${tripId}`);

            const trip = allTrips.find((t) => t._id === tripId);
            if (!trip) {
                showNotification("Erreur : Le voyage est introuvable.", "error");
                return;
            }

            // ‚úÖ CORRECTION : On utilise closeModal() au lieu de closeAllAdminModals()
            const detailsModal = document.getElementById('details-modal');
            if (detailsModal && detailsModal.classList.contains('active')) {
                detailsModal.classList.remove('active');
            }

            // ‚úÖ Petit d√©lai pour laisser le navigateur rafra√Æchir l'affichage
            await new Promise(resolve => setTimeout(resolve, 50));

            // ‚úÖ Afficher la modale de confirmation personnalis√©e
            const confirmed = await showAdminConfirm({
                title: "Supprimer ce Voyage ?",
                message: `Voulez-vous vraiment supprimer le voyage du ${new Date(trip.date).toLocaleDateString("fr-FR")} pour le trajet : \n\n"${trip.route.from} ‚Üí ${trip.route.to}" ?\n\nCette action est irr√©versible.`,
                icon: 'üóëÔ∏è',
                iconClass: 'danger',
                confirmText: 'Oui, supprimer',
                confirmClass: 'btn-danger'
            });

            // Si l'utilisateur n'a pas confirm√©, on arr√™te la fonction ici
            if (!confirmed) {
                return;
            }

            // ‚úÖ Si confirm√©, on proc√®de √† l'appel API
            const data = await apiCall(`/admin/trips/${tripId}`, "DELETE");

            if (data && data.success) {
                showNotification(data.message, "success");
                loadAllTrips(); // Recharger la liste pour voir le voyage dispara√Ætre
            }
        }


        // ============================================
        // üèôÔ∏è GESTION DES DESTINATIONS
        // ============================================

async function loadAllDestinations() {
    console.log("Chargement des destinations...");
    const data = await apiCall('/admin/destinations');
    if (!data || !data.success) return;

    // ‚úÖ ON ATTEND 500ms AVANT D'INS√âRER LE HTML
    setTimeout(() => {
        renderDestinationsTable(data.destinations);
    }, 500); // 500ms > 400ms de l'animation
}


function renderDestinationsTable(destinations) {
    const tbody = document.getElementById('destinations-body');
    if (!tbody) {
        console.error("L'√©l√©ment 'destinations-body' n'a pas √©t√© trouv√©.");
        return;
    }

    if (!destinations || destinations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4">Aucune destination.</td></tr>';
        return;
    }

    let html = '';
    destinations.forEach(dest => {
        html += `
            <tr>
                <td><strong class="font-bold">${dest.name}</strong></td>
                <td>${dest.country}</td>
                <td>
                    <span class="badge ${dest.isActive ? 'badge-success' : 'badge-gray'}">
                        ${dest.isActive ? 'Actif' : 'Inactif'}
                    </span>
                </td>
                <td class="actions-cell">
                    <button class="btn btn-sm btn-ghost" onclick="toggleDestinationStatus('${dest._id}', ${!dest.isActive})">
                        ${dest.isActive ? 'D√©sactiver' : 'Activer'}
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteDestination('${dest._id}', '${dest.name}')">
                        Supprimer
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}


//render destination table 



        async function handleCreateDestination(e) {
            e.preventDefault();
            const name = document.getElementById('dest-name').value;
            const country = document.getElementById('dest-country').value;
            const coordsStr = document.getElementById('dest-coords').value;

            // Convertir les coordonn√©es en tableau de nombres
            const coords = coordsStr.split(',').map(c => parseFloat(c.trim()));

            if (!name || !country) {
                showNotification('Le nom et le pays sont requis.', 'warning');
                return;
            }

            const data = await apiCall('/admin/destinations', 'POST', { name, country, coords });
            if (data && data.success) {
                showNotification('Destination ajout√©e !', 'success');
                document.getElementById('destination-creation-form').reset();
                loadAllDestinations(); // Recharger la table
            }
        }

        async function toggleDestinationStatus(id, newStatus) {
            const action = newStatus ? 'activer' : 'd√©sactiver';
            const confirmed = await showAdminConfirm({
                title: `Confirmer ?`,
                message: `Voulez-vous vraiment ${action} cette destination ?`,
                confirmText: `Oui, ${action}`
            });
            if (!confirmed) return;

            const data = await apiCall(`/admin/destinations/${id}`, 'PATCH', { isActive: newStatus });
            if (data && data.success) {
                showNotification('Statut mis √† jour.', 'success');
                loadAllDestinations();
            }
        }

        async function deleteDestination(id, name) {
            const confirmed = await showAdminConfirm({
                title: "Supprimer la destination ?",
                message: `ATTENTION : Vous √™tes sur le point de supprimer "${name}". Cette action est irr√©versible.`,
                icon: 'üóëÔ∏è',
                iconClass: 'danger',
                confirmText: 'Oui, supprimer'
            });
            if (!confirmed) return;

            const data = await apiCall(`/admin/destinations/${id}`, 'DELETE');
            if (data && data.success) {
                showNotification('Destination supprim√©e.', 'success');
                loadAllDestinations();
            }
        }

        // ============================================
        // üé¨ NAVIGATION
        // ============================================
        // DANS Admin/index.

        function switchTab(tabName) {
            console.log(`üöÄ DEMANDE DE CHANGEMENT D'ONGLET VERS : ${tabName}`);

            // 1. D√©sactiver tous les onglets
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });

            // 2. D√©sactiver tous les liens
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));

            // 3. Activer le bon lien
            // On doit aussi g√©rer le cas de la modale "Param√®tres" qui n'a pas de data-tab
            const activeLink = document.querySelector(`.nav-link[data-tab="${tabName}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
                console.log(`‚úÖ Lien activ√© pour : ${tabName}`);
            }

            // 4. Activer le bon onglet
            const activeTab = document.getElementById(`tab-${tabName}`);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.style.display = 'block';
                console.log(`‚úÖ Onglet activ√© et affich√© : tab-${tabName}`);
            } else {
                // Ce n'est pas une erreur critique si l'onglet n'existe pas (cas de la modale)
                console.warn(`‚ö†Ô∏è L'onglet "tab-${tabName}" n'existe pas. Aucune vue √† afficher.`);
                return;
            }

            // 5. Charger les donn√©es correspondantes
            if (tabName !== 'reservations') {
                stopCountdownUpdates();
            }

            switch (tabName) {
                case 'reservations':
                    loadAdminData();
                    break;
                case 'report-requests':
                    loadReportRequests();
                    break;
                case 'trips':
                    loadAllTemplates().then(loadAllTrips);
                    break;
                case 'templates':
                    loadAllTemplates();
                    break;

                // ===================================
                // ‚úÖ LE CAS MANQUANT EST ICI
                // ===================================
                case 'destinations':
                    loadAllDestinations();
                    break;

                default:
                    // Ne fait rien pour 'settings' car il ouvre une modale, pas un onglet.
                    if (tabName !== 'settings') {
                        console.warn(`‚ö†Ô∏è Aucun chargement de donn√©es pr√©vu pour : ${tabName}`);
                    }
            }
        }
        // ============================================
        // üéØ INITIALISATION
        // ============================================
        function buildDaysSelector() {
            const days = [
                { v: "monday", l: "Lun" },
                { v: "tuesday", l: "Mar" },
                { v: "wednesday", l: "Mer" },
                { v: "thursday", l: "Jeu" },
                { v: "friday", l: "Ven" },
                { v: "saturday", l: "Sam" },
                { v: "sunday", l: "Dim" },
            ];

            const container = document.getElementById("days-selector");
            container.innerHTML = days
                .map(
                    (d) => `
                <div class="day-checkbox">
                    <input type="checkbox" id="day-${d.v}" value="${d.v}" ${d.v !== "sunday" ? "checked" : ""
                        }>
                    <label for="day-${d.v}">${d.l}</label>
                </div>
            `
                )
                .join("");
        }

        // ============================================
        // üéØ INITIALISATION & √âV√âNEMENTS
        // ============================================

        // DANS admin/index.html, dans <script>




        async function loadSettings() {
            console.log('üîÑ Chargement des param√®tres...');
            try {
                const data = await apiCall('/admin/settings/report');
                console.log('üì¶ Donn√©es re√ßues:', data);

                if (!data || !data.success) {
                    console.error('‚ùå Erreur: succ√®s=false ou data vide');
                    return;
                }

                const settings = data.settings;
                console.log('‚öôÔ∏è Settings:', settings);

                // V√©rification des √©l√©ments DOM
                const elSecond = document.getElementById('setting-second-fee');
                console.log('√âl√©ment second-fee existe ?', !!elSecond);

                if (elSecond) {
                    document.getElementById('setting-second-fee').value = settings.secondReportFee;
                    document.getElementById('setting-third-fee').value = settings.thirdReportFee;
                    document.getElementById('setting-max-reports').value = settings.maxReportsAllowed;
                    document.getElementById('setting-min-hours').value = settings.minHoursBeforeDeparture;
                    console.log('‚úÖ Champs remplis !');
                }

            } catch (error) {
                console.error('‚ùå Erreur chargement param√®tres:', error);
                showNotification('Impossible de charger les param√®tres', 'error');
            }
        }

        async function saveSettings(e) {
            e.preventDefault();

            const updates = {
                secondReportFee: parseInt(document.getElementById('setting-second-fee').value),
                thirdReportFee: parseInt(document.getElementById('setting-third-fee').value),
                maxReportsAllowed: parseInt(document.getElementById('setting-max-reports').value),
                minHoursBeforeDeparture: parseInt(document.getElementById('setting-min-hours').value)
            };

            try {
                const data = await apiCall('/admin/settings/report', 'PATCH', updates);

                if (data && data.success) {
                    showNotification('‚úÖ Param√®tres mis √† jour avec succ√®s !', 'success');
                }

            } catch (error) {
                console.error('‚ùå Erreur sauvegarde param√®tres:', error);
                showNotification('Erreur lors de la sauvegarde', 'error');
            }
        }

        function setupEventListeners() {
            // --- Login & Logout (INCHANG√â) ---
            document.getElementById("login-form").addEventListener("submit", handleLogin);
            document.getElementById("logout-btn").addEventListener("click", handleLogout);

            // --- Gestion de la navigation par onglets (INCHANG√â) ---
            document.querySelectorAll(".nav-link").forEach((link) => {
                link.addEventListener("click", (e) => {
                    e.preventDefault();
                    const tabName = link.getAttribute("data-tab");
                    switchTab(tabName);
                });
            });

            // --- Filtres (INCHANG√â) ---
            document.getElementById("search-input").addEventListener("input", applyFilters);
            document.querySelectorAll(".filter-pill").forEach((pill) => {
                pill.addEventListener("click", () => {
                    document.querySelectorAll(".filter-pill").forEach((p) => p.classList.remove("active"));
                    pill.classList.add("active");
                    applyFilters();
                });
            });

            // --- Forms (INCHANG√â) ---
            document.getElementById("template-creation-form").addEventListener("submit", handleCreateTemplate);
            document.getElementById("trip-creation-form").addEventListener("submit", handleCreateTrips);

            // --- Modal (INCHANG√â) ---
            window.addEventListener("click", (e) => {
                if (e.target === document.getElementById("details-modal")) {
                    closeModal();
                }
            });

            // --- D√©l√©gation d'√©v√©nements pour le tableau des voyages (INCHANG√â) ---
            const tripsTbody = document.getElementById('trips-body');
            if (tripsTbody) {
                tripsTbody.addEventListener('click', (event) => {
                    const button = event.target.closest('button[data-action]');
                    if (!button) return;
                    const action = button.dataset.action;
                    const tripId = button.dataset.tripId;
                    switch (action) {
                        case 'delete': deleteTrip(tripId); break;
                        case 'manage-seats': manageSeats(tripId); break;
                        case 'edit-trip': showEditTripModal(tripId); break;
                        case 'reset-seats': resetTripSeats(tripId); break;
                    }
                });
            }

            // √âcouteur pour le formulaire des param√®tres de report (INCHANG√â)
            const settingsForm = document.getElementById("report-settings-form");
            if (settingsForm) {
                settingsForm.addEventListener("submit", saveSettings);
            }

            // ===================================
            // ‚úÖ AJOUT DE L'√âCOUTEUR MANQUANT
            // ===================================
            const destForm = document.getElementById("destination-creation-form");
            if (destForm) {
                destForm.addEventListener("submit", handleCreateDestination);
            }
            // ===================================
        }
        document.addEventListener("DOMContentLoaded", async () => {
            // 1. V√©rification du token et affichage initial (votre code est correct)
            if (await verifyToken()) {
                showDashboard();
                loadAdminData(); // Charge les r√©servations par d√©faut
                startInactivityDetection();
            } else {
                localStorage.removeItem("admin_token");
                showLogin();
            }

            // 2. Initialisation des √©couteurs d'√©v√©nements (votre code est correct)
            setupEventListeners();
            buildDaysSelector();

            // 3. Initialisation des calendriers Flatpickr

            // Calendrier pour la cr√©ation de voyages (votre code est correct)
            flatpickr("#trip-dates", {
                mode: "range",
                dateFormat: "Y-m-d",
                locale: "fr",
                minDate: "today",
            });

            // ===================================
            // ‚úÖ AJOUT POUR LE NOUVEAU FILTRE
            // ===================================
            // Calendrier pour filtrer les voyages programm√©s
            const tripFilterDateInput = document.getElementById('trip-filter-date');
            if (tripFilterDateInput) {
                flatpickr(tripFilterDateInput, {
                    dateFormat: "Y-m-d",
                    locale: "fr",
                    allowInput: true, // Permet de vider le champ
                    onChange: function (selectedDates, dateStr, instance) {
                        // On recharge la liste des voyages quand la date change
                        if (typeof loadAllTrips === 'function') {
                            loadAllTrips();
                        }
                    }
                });
            }
            // ===================================
        });

        // ============================================
        // üõë GESTION DYNAMIQUE DES ARR√äTS
        // ============================================

        function toggleTripOptions() {
            const tripType = document.getElementById("template-trip-type").value;
            const stopsSection = document.getElementById("stops-section");
            const connectionsSection = document.getElementById(
                "connections-section"
            );

            stopsSection.style.display = tripType === "stops" ? "block" : "none";
            connectionsSection.style.display =
                tripType === "connections" ? "block" : "none";
        }

        let stopCounter = 0;
        function addStop() {
            const container = document.getElementById("stops-container");
            const stopId = `stop-${stopCounter++}`;

            const stopDiv = document.createElement("div");
            stopDiv.className = "stop-item";
            stopDiv.id = stopId;
            stopDiv.innerHTML = `
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 12px; padding: 12px; background: var(--dark-elevated); border-radius: 8px; margin-bottom: 12px;">
            <input type="text" placeholder="Ville de l'arr√™t" class="form-control stop-city" required>
            <input type="time" placeholder="Arriv√©e" class="form-control stop-arrival" required>
            <input type="time" placeholder="D√©part" class="form-control stop-departure" required>
            <input type="text" placeholder="Dur√©e (ex: 15min)" class="form-control stop-duration" required>
            <button type="button" class="btn btn-danger btn-icon" onclick="removeStop('${stopId}')">üóëÔ∏è</button>
        </div>
    `;
            container.appendChild(stopDiv);
        }

        function removeStop(stopId) {
            document.getElementById(stopId).remove();
        }

        let connectionCounter = 0;
        // Dans Admin/index.html (section <script>)
        function addConnection() {
            const container = document.getElementById("connections-container");
            const connId = `connection-${connectionCounter++}`;

            const connDiv = document.createElement("div");
            connDiv.className = "connection-item";
            connDiv.id = connId;
            connDiv.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr auto; gap: 12px; padding: 12px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; margin-bottom: 12px; border: 1px solid #ffc107;">
            <input type="text" placeholder="Ville" class="form-control conn-city" required>
            <input type="time" placeholder="Arriv√©e" class="form-control conn-arrival" required>
            <input type="text" placeholder="Attente" class="form-control conn-wait" required>
            <input type="time" placeholder="Prochain d√©part" class="form-control conn-next-departure" required>
            <input type="text" placeholder="Compagnie partenaire" class="form-control conn-next-company" required>
            <input type="text" placeholder="N¬∞ Bus partenaire" class="form-control conn-next-bus-number">
            <button type="button" class="btn btn-danger btn-icon" onclick="removeConnection('${connId}')">üóëÔ∏è</button>
        </div>
    `;
            container.appendChild(connDiv);
        }

        function removeConnection(connId) {
            document.getElementById(connId).remove();
        }

        // Dans Admin/index.html (section <script>)
        function showEditTemplateModal(templateId) {
            const template = allTemplates.find((t) => t._id === templateId);
            if (!template) return;

            // Utiliser des valeurs par d√©faut si baggageOptions n'existe pas
            const baggage = template.baggageOptions || {
                standard: { included: 1, max: 5, price: 2000 },
                oversized: { max: 2, price: 5000 },
            };

            document.getElementById("modal-title").textContent =
                "Modifier le Mod√®le de Trajet";
            document.getElementById("modal-body").innerHTML = `
        <form id="edit-template-form">
            <!-- ... (champs from, to, company, price, etc.) ... -->
            <!-- Gestion des bagages -->
            <div class="form-group form-group-full">
                <h4>Options des bagages</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="edit-standard-baggage-included">Bagages standards inclus</label>
                        <input type="number" id="edit-standard-baggage-included" class="form-control" value="${baggage.standard.included}">
                    </div>
                    <!-- ... (autres champs de bagages) ... -->
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Enregistrer</button>
        </form>
    `;

            document
                .getElementById("edit-template-form")
                .addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const updates = {
                        // ... (r√©cup√©rer les valeurs des champs)
                        standardBaggageIncluded: document.getElementById(
                            "edit-standard-baggage-included"
                        ).value,
                        // ...
                    };
                    const data = await apiCall(
                        `/admin/route-templates/${templateId}`,
                        "PATCH",
                        updates
                    );
                    if (data) {
                        showNotification(data.message, "success");
                        closeModal();
                        loadAllTemplates();
                    }
                });

            document.getElementById("details-modal").classList.add("active");
        }

        // Dans Admin/index.html (section <script>)
        // Dans Admin/index.html (section <script>)

        // ============================================
        // üí∫ MODIFICATION DES SI√àGES D'UNE R√âSERVATION
        // ============================================

        // DANS Admin/index.html, REMPLACEZ la fonction showChangeSeatsModal

        async function showChangeSeatsModal(reservationId) {
            console.log("üîç Ouverture modal modification si√®ges pour:", reservationId);

            // 1. S√©curit√© : V√©rifier l'ID et trouver la r√©servation
            if (!reservationId || reservationId.length !== 24) {
                showNotification("ID de r√©servation invalide.", "error");
                return;
            }
            const reservation = allReservations.find(r => r._id === reservationId);
            if (!reservation) {
                showNotification("Erreur : r√©servation non trouv√©e.", "error");
                return;
            }

            // 2. R√©cup√©rer les donn√©es des si√®ges du voyage associ√©
            const tripId = reservation.route.id;
            console.log("üìç ID du voyage associ√©:", tripId);
            const tripSeatsData = await apiCall(`/trips/${tripId}/seats`);
            if (!tripSeatsData || !tripSeatsData.seats) {
                showNotification("Erreur : impossible de charger les si√®ges du voyage.", "error");
                return;
            }
            console.log("‚úÖ Donn√©es si√®ges charg√©es.", tripSeatsData);

            // 3. Pr√©parer les donn√©es pour l'affichage
            document.getElementById('modal-title').textContent = `Modifier les si√®ges - ${reservation.bookingNumber}`;
            const currentSeats = reservation.seats.map(s => parseInt(s));
            console.log("ü™ë Si√®ges actuels de la r√©servation:", currentSeats);

            // 4. Construire le HTML de la grille des si√®ges
            let seatsGridHTML = '';
            tripSeatsData.seats.forEach((seat, index) => {
                let seatClass = 'seat';
                let onClick = '';
                let title = `Si√®ge ${seat.number}`;
                const isCurrentSeat = currentSeats.includes(seat.number);

                if (isCurrentSeat) {
                    seatClass += ' selected'; // Pr√©-s√©lectionn√©
                    onClick = `onclick="toggleAdminSeat(this, ${seat.number})"`;
                    title += ' (Si√®ge actuel)';
                } else if (seat.status === 'available' || seat.status === 'blocked') {
                    seatClass += ` seat-${seat.status}`;
                    onClick = `onclick="toggleAdminSeat(this, ${seat.number})"`;
                    title += ` - ${seat.status}`;
                } else { // 'occupied' par un autre client
                    seatClass += ' seat-occupied';
                    title += ' - Occup√©';
                }
                seatsGridHTML += `<div class="${seatClass}" ${onClick} title="${title}" data-seat-number="${seat.number}">${seat.number}</div>`;
                if ((index + 1) % 2 === 0 && (index + 1) % 4 !== 0) {
                    seatsGridHTML += '<div class="seat-aisle"></div>';
                }
            });

            // 5. Construire le HTML complet de la modale
            const modalBodyHTML = `
        <div style="margin-bottom: 20px; padding: 15px; background: var(--dark-elevated); border-radius: 8px; border-left: 4px solid var(--primary);">
            <p style="margin: 0; color: var(--text-secondary); font-size: 0.95rem;">
                <strong style="color: var(--primary);">Passagers :</strong> ${reservation.passengers.length}<br>
                <strong style="color: var(--accent);">S√©lectionnez ${reservation.passengers.length} si√®ge(s) au total.</strong>
            </p>
        </div>
        <div class="seat-map-container"><div class="seat-map">${seatsGridHTML}</div></div>
        <div class="seat-legend">
            <div class="legend-item"><div class="legend-box" style="background:var(--primary);"></div><span>Disponible</span></div>
            <div class="legend-item"><div class="legend-box" style="background:var(--status-cancelled);"></div><span>Occup√©</span></div>
            <div class="legend-item"><div class="legend-box" style="background:var(--dark-border);"></div><span>Bloqu√©</span></div>
            <div class="legend-item"><div class="legend-box" style="background: #2196F3; border: 2px solid white;"></div><span>S√©lectionn√©</span></div>
        </div>
        <div style="margin: 20px 0; padding: 15px; background: var(--dark-elevated); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <span style="color: var(--text-secondary);">Si√®ges s√©lectionn√©s :</span>
                <strong id="selected-seats-count" style="color: var(--primary); font-size: 1.25rem; margin-left: 10px;">${currentSeats.length}</strong>
                <span style="color: var(--text-muted);"> / ${reservation.passengers.length}</span>
            </div>
            <div id="selected-seats-list" style="color: var(--accent); font-weight: 600; font-family: var(--font-mono);">${currentSeats.sort((a, b) => a - b).join(', ')}</div>
        </div>
        <button id="save-seats-btn" class="btn btn-primary mt-4" disabled>üíæ Enregistrer les nouveaux si√®ges</button>
    `;

            document.getElementById('modal-body').innerHTML = modalBodyHTML;
            document.getElementById('details-modal').classList.add('active');

            updateAdminSeatSelection();
            updateSelectedSeatsDisplay(); // Met √† jour l'√©tat du bouton initial

            // 6. Attacher l'√©v√©nement au bouton "Enregistrer"
            document.getElementById('save-seats-btn').onclick = async () => {
                const selectedSeatsElements = document.querySelectorAll('.seat.selected');
                // ‚úÖ CORRECTION : Conversion explicite en entiers avec validation
                const newSeats = Array.from(selectedSeatsElements)
                    .map(el => {
                        const seatNumber = el.dataset.seatNumber;
                        return parseInt(seatNumber, 10); // Toujours sp√©cifier la base 10
                    })
                    .filter(num => !isNaN(num) && Number.isInteger(num)) // Filtrer les valeurs invalides
                    .sort((a, b) => a - b);

                console.log("üéØ Nouveaux si√®ges √† envoyer (v√©rifi√©s) :", newSeats);
                console.log("Type du premier √©l√©ment :", typeof newSeats[0], newSeats[0]);

                if (newSeats.length !== reservation.passengers.length) {
                    showNotification(`Veuillez s√©lectionner exactement ${reservation.passengers.length} si√®ge(s).`, 'warning');
                    return;
                }

                const saveBtn = document.getElementById('save-seats-btn');
                saveBtn.disabled = true;
                saveBtn.textContent = '‚è≥ Enregistrement...';

                console.log(`üì° Envoi de la requ√™te PATCH √† /admin/reservations/${reservationId}/seats`);
                console.log("üì¶ Corps de la requ√™te :", JSON.stringify({ newSeats }, null, 2));

                const data = await apiCall(`/admin/reservations/${reservationId}/seats`, 'PATCH', { newSeats });

                console.log("üì¶ R√©ponse du serveur √† la modification :", data);

                if (data && data.success) {
                    showNotification('Si√®ges modifi√©s avec succ√®s !', 'success');
                    closeModal();
                    loadAdminData();
                } else {
                    showNotification(data?.error || 'Erreur lors de la modification.', 'error');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'üíæ Enregistrer les nouveaux si√®ges';
                }

            };
        }
        // ============================================
        // üéØ TOGGLE SI√àGE (ADMIN)
        // ============================================
        function toggleAdminSeat(element, seatNumber) {
            // Ajoute ou enl√®ve simplement la classe 'selected'. Le CSS s'occupera du style.
            element.classList.toggle('selected');
            updateSelectedSeatsDisplay(); // Met √† jour le compteur
        }
        // ============================================
        // üìä MISE √Ä JOUR DE L'AFFICHAGE DES SI√àGES S√âLECTIONN√âS
        // ============================================

        function updateSelectedSeatsDisplay() {
            const selectedSeatsElements =
                document.querySelectorAll(".seat.selected");
            const selectedSeats = Array.from(selectedSeatsElements)
                .map((el) => parseInt(el.dataset.seatNumber))
                .sort((a, b) => a - b);

            const countElement = document.getElementById("selected-seats-count");
            const listElement = document.getElementById("selected-seats-list");

            if (countElement) {
                countElement.textContent = selectedSeats.length;
            }

            if (listElement) {
                listElement.textContent =
                    selectedSeats.length > 0
                        ? selectedSeats.join(", ")
                        : "Aucun si√®ge s√©lectionn√©";
            }
        }

        // Fonction helper pour toggle les si√®ges
        function toggleAdminSeat(element, seatNumber) {
            element.classList.toggle("selected");

            // Changer visuellement le statut
            if (element.classList.contains("selected")) {
                element.style.background = "#2196F3";
                element.style.color = "white";
                element.style.border = "3px solid white";
            } else {
                // Restaurer le style original
                element.style = "";
            }

            updateSelectedSeatsCount();
        }

        // Fonction pour mettre √† jour le compteur et activer/d√©sactiver le bouton
        function updateSelectedSeatsCount() {
            const selectedCount =
                document.querySelectorAll(".seat.selected").length;
            const totalRequired = parseInt(
                document
                    .querySelector("#selected-seats-count")
                    .parentElement.textContent.split("/")[1]
            );

            document.getElementById("selected-seats-count").textContent =
                selectedCount;

            const saveButton = document.getElementById("save-seats-btn");
            if (saveButton) {
                saveButton.disabled = selectedCount !== totalRequired;
                if (selectedCount === totalRequired) {
                    saveButton.style.opacity = "1";
                } else {
                    saveButton.style.opacity = "0.5";
                }
            }
        }
        // DANS Admin/index.html, REMPLACEZ la fonction toggleAdminSeat par celle-ci

        function toggleAdminSeat(element, seatNumber) {
            // Ajoute ou enl√®ve simplement la classe 'selected'. Le CSS s'occupera du style.
            element.classList.toggle('selected');

            // ‚úÖ APPEL CRUCIAL : Mettre √† jour le compteur et l'√©tat du bouton
            updateAdminSeatSelection();
        }
        // DANS Admin/index.html, AJOUTEZ cette nouvelle fonction

        function updateAdminSeatSelection() {
            const selectedSeatsElements = document.querySelectorAll('.seat.selected');
            const selectedSeats = Array.from(selectedSeatsElements)
                .map(el => parseInt(el.dataset.seatNumber))
                .sort((a, b) => a - b);

            const countElement = document.getElementById('selected-seats-count');
            const listElement = document.getElementById('selected-seats-list');
            const saveBtn = document.getElementById('save-seats-btn');

            // Mettre √† jour le texte du compteur et de la liste
            if (countElement) {
                countElement.textContent = selectedSeats.length;
            }
            if (listElement) {
                listElement.textContent = selectedSeats.length > 0 ? selectedSeats.join(', ') : 'Aucun';
            }

            // Activer ou d√©sactiver le bouton "Enregistrer"
            if (saveBtn) {
                const passengerCountText = document.querySelector('#selected-seats-count + span')?.textContent;
                if (passengerCountText) {
                    const requiredCount = parseInt(passengerCountText.replace('/', '').trim());

                    // Le bouton est activ√© SEULEMENT si le compte est bon
                    saveBtn.disabled = selectedSeats.length !== requiredCount;
                } else {
                    // S√©curit√© : si on ne peut pas trouver le nombre requis, on d√©sactive
                    saveBtn.disabled = true;
                }
            }
        }

        // DANS Admin/index.html, dans la balise <script>

        // ============================================
        // ‚úÖ NOUVELLE FONCTION : R√âINITIALISER LES SI√àGES
        // ============================================
        // DANS Admin/index.html, REMPLACEZ la fonction resetTripSeats

        async function resetTripSeats(tripId) {
            const trip = allTrips.find(t => t._id === tripId);
            if (!trip) return;

            // ‚úÖ Utilisation de la modale personnalis√©e pour l'avertissement
            const confirmed = await showAdminConfirm({
                title: "R√©initialiser tous les si√®ges ?",
                message: `√ätes-vous absolument certain de vouloir r√©initialiser TOUS les si√®ges pour le voyage :\n\n${trip.route.from} ‚Üí ${trip.route.to} du ${new Date(trip.date).toLocaleDateString('fr-FR')} ?\n\n‚ö†Ô∏è Cette action est IRREVERSIBLE et lib√©rera √©galement les si√®ges d√©j√† r√©serv√©s par des clients.`,
                icon: 'üîÑ',
                iconClass: 'danger',
                confirmText: 'Oui, r√©initialiser',
                confirmClass: 'btn-danger'
            });

            if (!confirmed) {
                return;
            }

            // Appel de la route API
            const data = await apiCall(`/admin/trips/${tripId}/reset-seats`, 'PATCH');

            if (data && data.success) {
                showNotification(data.message, 'success');
                loadAllTrips(); // Recharger la table pour voir les changements
            }
        }


        // DANS Admin/index.html, dans <script>

        function showAdminConfirm({ title, message, icon = '‚ö†Ô∏è', iconClass = 'warning', confirmText = 'Confirmer', cancelText = 'Annuler', confirmClass = 'btn-danger' }) {
            return new Promise((resolve) => {
                const modal = document.getElementById('admin-confirm-modal');
                const titleEl = document.getElementById('admin-confirm-title');
                const messageEl = document.getElementById('admin-confirm-message');
                const iconEl = document.getElementById('admin-confirm-icon');
                const okBtn = document.getElementById('admin-confirm-ok-btn');
                const cancelBtn = document.getElementById('admin-confirm-cancel-btn');

                titleEl.textContent = title;
                messageEl.textContent = message;
                iconEl.textContent = icon;
                iconEl.className = `custom-modal-icon ${iconClass}`;
                okBtn.textContent = confirmText;
                cancelBtn.textContent = cancelText;
                okBtn.className = `btn ${confirmClass}`;

                modal.style.display = 'flex';

                const close = (result) => {
                    modal.style.display = 'none';
                    okBtn.onclick = null;
                    cancelBtn.onclick = null;
                    resolve(result);
                };

                okBtn.onclick = () => close(true);
                cancelBtn.onclick = () => close(false);
            });
        }



        // DANS Admin/index.html, dans <script>

        function showAdminInputModal({ title, message, icon = 'üìù', iconClass = 'info', label, placeholder, confirmText = 'Valider' }) {
            return new Promise((resolve) => {
                const modal = document.getElementById('input-modal');
                const titleEl = document.getElementById('input-modal-title');
                const messageEl = document.getElementById('input-modal-message');
                const iconEl = document.getElementById('input-modal-icon');
                const labelEl = document.getElementById('input-modal-label');
                const inputEl = document.getElementById('input-modal-field');
                const errorEl = document.getElementById('input-modal-error');
                const okBtn = document.getElementById('input-modal-ok-btn');
                const cancelBtn = document.getElementById('input-modal-cancel-btn');

                // Remplir les √©l√©ments de la modale
                titleEl.textContent = title;
                messageEl.textContent = message;
                iconEl.textContent = icon;
                iconEl.className = `custom-modal-icon ${iconClass}`;
                labelEl.textContent = label;
                inputEl.placeholder = placeholder || '';
                okBtn.textContent = confirmText;

                // R√©initialiser les champs
                inputEl.value = '';
                errorEl.style.display = 'none';

                modal.style.display = 'flex';
                inputEl.focus();

                const close = (value) => {
                    modal.style.display = 'none';
                    okBtn.onclick = null;
                    cancelBtn.onclick = null;
                    document.removeEventListener('keydown', keydownHandler);
                    resolve(value); // Renvoie la valeur saisie ou null
                };

                const keydownHandler = (e) => {
                    if (e.key === 'Enter') {
                        okBtn.click();
                    } else if (e.key === 'Escape') {
                        cancelBtn.click();
                    }
                };

                okBtn.onclick = () => {
                    const value = inputEl.value.trim();
                    if (!value) {
                        errorEl.textContent = 'Ce champ ne peut pas √™tre vide.';
                        errorEl.style.display = 'block';
                        return;
                    }
                    close(value);
                };

                cancelBtn.onclick = () => close(null); // Renvoie null si annul√©

                document.addEventListener('keydown', keydownHandler);
            });
        }



        // ============================================
        // üîÑ GESTION DES DEMANDES DE REPORT
        // ============================================

        async function loadReportRequests() {
            try {
                // ‚úÖ On r√©cup√®re la valeur du champ de recherche
                const searchTerm = document.getElementById('report-search-input').value.trim();

                // ‚úÖ On construit l'URL avec le param√®tre de recherche
                const endpoint = searchTerm
                    ? `/admin/reports/history?search=${encodeURIComponent(searchTerm)}`
                    : '/admin/reports/history';

                const data = await apiCall(endpoint);

                if (!data) {
                    document.getElementById('report-requests-body').innerHTML = `<tr><td colspan="7" class="text-center">Erreur de chargement.</td></tr>`;
                    return;
                }

                const pendingRequests = data.reports.filter(r => r.status === 'En attente de report');
                const processedReports = data.reports.filter(r => r.status !== 'En attente de report');

                displayReportRequestsStats(pendingRequests);
                renderReportRequestsTable(pendingRequests, processedReports);

            } catch (error) {
                console.error('‚ùå Erreur chargement historique des reports:', error);
                showNotification('Erreur lors du chargement de l\'historique', 'error');
            }
        }
        function displayReportRequestsStats(requests) {
            const statsGrid = document.getElementById('report-stats-grid');

            const pending = requests.filter(r => r.status === 'En attente de report').length;
            const totalAmount = requests.reduce((sum, r) => sum + (r.reportRequest?.cost?.totalCost || 0), 0);

            statsGrid.innerHTML = `
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">En attente</span>
                <div class="stat-icon warning">‚è≥</div>
            </div>
            <div class="stat-value">${pending}</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Total √† encaisser</span>
                <div class="stat-icon primary">üí∞</div>
            </div>
            <div class="stat-value">${formatPrice(totalAmount)} FCFA</div>
        </div>
    `;
        }
        function renderReportRequestsTable(pending, processed) {
            const tbody = document.getElementById('report-requests-body');
            if (!tbody) return;

            if (pending.length === 0 && processed.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center">Aucun report trouv√©.</td></tr>`;
                return;
            }

            let htmlContent = '';

            const createRowHTML = (req) => {
                const passenger = req.passengers?.[0] || { name: 'N/A', phone: 'N/A' };

                let statusBadge = '', fromHTML = '', toHTML = '', paymentHTML = '', requestedDate = '', actionsHTML = '';

                if (req.status === 'En attente de report' && req.reportRequest) {
                    statusBadge = '<span class="badge badge-warning">En attente</span>';
                    fromHTML = `${req.route.from} ‚Üí ${req.route.to}<br><small>üìÖ ${new Date(req.date).toLocaleDateString('fr-FR')}</small>`;
                    toHTML = `${req.reportRequest.targetTrip.route.from} ‚Üí ${req.reportRequest.targetTrip.route.to}<br><small>üìÖ ${new Date(req.reportRequest.targetTrip.date).toLocaleDateString('fr-FR')}</small>`;

                    const proof = req.reportRequest.paymentMethod === 'AGENCY'
                        ? req.reportRequest.agencyPaymentCode
                        : req.reportRequest.transactionId;

                    paymentHTML = `<strong>${formatPrice(req.reportRequest.cost?.totalCost || 0)} FCFA</strong><br><small>Preuve: ${proof || 'N/A'}</small>`;
                    requestedDate = new Date(req.reportRequest.requestedAt).toLocaleString('fr-FR');

                    const proofForApproval = req.reportRequest.paymentMethod === 'AGENCY' ? 'PAIEMENT_AGENCE' : (req.reportRequest.transactionId || '');

                    actionsHTML = `
                <button class="btn btn-icon btn-success" onclick="approveReportRequest('${req.bookingNumber}', '${proofForApproval}')">‚úÖ</button>
                <button class="btn btn-icon btn-danger" onclick="rejectReportRequest('${req.bookingNumber}')">‚ùå</button>
            `;
                }
                else if (req.status === 'Report√©') {
                    statusBadge = '<span class="badge badge-gray">Obsol√®te</span>';
                    fromHTML = `${req.route.from} ‚Üí ${req.route.to}<br><small>üìÖ ${new Date(req.date).toLocaleDateString('fr-FR')}</small>`;
                    toHTML = `<small>Remplac√© par <strong>${req.replacementBookingNumber || '...'}</strong></small>`;
                    paymentHTML = `-`;
                    requestedDate = new Date(req.reportedAt).toLocaleString('fr-FR');
                    actionsHTML = `<span>-</span>`;
                }
                else if (req.originalReservation) {
                    statusBadge = '<span class="badge badge-success">Valid√©</span>';
                    const history = req.reportHistory[req.reportHistory.length - 1];

                    if (history && history.from && history.to) {
                        fromHTML = `(Report de ...)<br><small>üìÖ ${new Date(history.from.date).toLocaleDateString('fr-FR')}</small>`;
                        toHTML = `${req.route.from} ‚Üí ${req.route.to}<br><small>üìÖ ${new Date(req.date).toLocaleDateString('fr-FR')}</small>`;
                        paymentHTML = `<strong>${formatPrice(history.totalCost || 0)} FCFA</strong><br><small>Preuve: ${history.transactionProof || 'GRATUIT'}</small>`;
                        requestedDate = new Date(history.reportedAt).toLocaleString('fr-FR');
                    }
                    actionsHTML = `<span>‚úì</span>`;
                }

                return `
            <tr style="${req.status === 'Report√©' ? 'opacity: 0.5; text-decoration: line-through;' : ''}">
                <td><strong class="font-mono">${req.bookingNumber}</strong><br>${statusBadge}</td>
                <td>${passenger.name}</td>
                <td>${fromHTML}</td>
                <td>${toHTML}</td>
                <td>${paymentHTML}</td>
                <td>${requestedDate}</td>
                <td class="actions-cell">${actionsHTML}</td>
            </tr>
        `;
            };

            if (pending.length > 0) htmlContent += pending.map(createRowHTML).join('');
            if (processed.length > 0) {
                htmlContent += `<tr><td colspan="7" style="background: var(--dark-elevated); text-align: center; font-weight: bold;">HISTORIQUE</td></tr>`;
                htmlContent += processed.map(createRowHTML).join('');
            }

            tbody.innerHTML = htmlContent;
        }

        async function approveReportRequest(bookingNumber, proofFromTable) {
            // 1. Log pour √™tre s√ªr que le clic fonctionne
            console.log(`‚ñ∂Ô∏è Validation demand√©e pour ${bookingNumber}. Preuve re√ßue: "${proofFromTable}"`);

            // 2. Demander une confirmation simple √† l'admin
            const confirmed = await showAdminConfirm({
                title: "Confirmer la validation ?",
                message: `Vous √™tes sur le point de valider le report pour la r√©servation ${bookingNumber}.\n\nAvez-vous v√©rifi√© le paiement ?`,
                icon: '‚úÖ',
                iconClass: 'success',
                confirmText: 'Oui, valider'
            });

            if (!confirmed) {
                showNotification('Validation annul√©e.', 'info');
                return;
            }

            // 3. Appel de l'API avec la preuve r√©cup√©r√©e
            try {
                const data = await apiCall(
                    `/admin/report-requests/${bookingNumber}/approve`,
                    'POST',
                    { transactionProof: proofFromTable } // On envoie simplement la preuve, le backend fera le tri
                );

                if (data && data.success) {
                    showNotification('Report valid√© avec succ√®s !', 'success');
                    loadReportRequests(); // Recharger la liste
                } else {
                    showNotification(data?.error || 'La validation a √©chou√©.', 'error');
                }
            } catch (error) {
                showNotification(`Erreur: ${error.message}`, 'error');
            }
        }
        // Rejeter une demande de report
        async function rejectReportRequest(bookingNumber) {
            const confirmed = await showAdminConfirm({
                title: "Rejeter cette demande ?",
                message: `Voulez-vous vraiment rejeter la demande de report pour ${bookingNumber} ?\n\nLa r√©servation reviendra √† son √©tat initial.`,
                icon: '‚ùå',
                iconClass: 'danger',
                confirmText: 'Oui, rejeter',
                confirmClass: 'btn-danger'
            });

            if (!confirmed) return;

            try {
                const data = await apiCall(`/admin/report-requests/${bookingNumber}`, 'DELETE');

                if (data && data.success) {
                    showNotification('Demande rejet√©e', 'success');
                    loadReportRequests();
                }

            } catch (error) {
                console.error('‚ùå Erreur rejet demande:', error);
                showNotification('Erreur lors du rejet', 'error');
            }
        }

        // Afficher les d√©tails d'une demande
        function showReportRequestDetails(bookingNumber) {
            // TODO: Afficher une modale avec tous les d√©tails
            showNotification('Fonctionnalit√© en cours de d√©veloppement', 'info');
        }

        // Fonction helper pour formater les prix
        function formatPrice(amount) {
            return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }


        async function openSettingsModal() {
            // D'abord, charger les donn√©es
            await loadSettings();
            // Ensuite, afficher la modale
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('active');
        }


    </script>

    <!-- DANS Admin/index.html, juste avant </body> -->

    <!-- ============================================
     ‚úÖ MODALE DE CONFIRMATION PERSONNALIS√âE ADMIN
     ============================================ -->
    <div id="admin-confirm-modal" class="custom-modal-overlay" style="display: none;">
        <div class="custom-modal-card">
            <div class="custom-modal-header">
                <span id="admin-confirm-icon" class="custom-modal-icon"></span>
                <h3 id="admin-confirm-title"></h3>
            </div>
            <div class="custom-modal-body">
                <p id="admin-confirm-message"></p>
            </div>
            <div class="custom-modal-footer">
                <button id="admin-confirm-cancel-btn" class="btn btn-ghost">Annuler</button>
                <button id="admin-confirm-ok-btn" class="btn btn-danger">Confirmer</button>
            </div>
        </div>
    </div> <!-- ‚úÖ CORRECTION : LA BALISE MANQUANTE EST AJOUT√âE ICI -->



    <!-- DANS Admin/index.html, juste avant </body> -->

    <!-- ============================================
     ‚úÖ MODALE DE SAISIE DE PREUVE DE PAIEMENT
     ============================================ -->
    <div id="input-modal" class="custom-modal-overlay" style="display: none;">
        <div class="custom-modal-card">
            <div class="custom-modal-header">
                <span id="input-modal-icon" class="custom-modal-icon"></span>
                <h3 id="input-modal-title"></h3>
            </div>
            <div class="custom-modal-body">
                <p id="input-modal-message"></p>
                <!-- Champ de saisie -->
                <div class="form-group" style="margin-top: 1rem;">
                    <label id="input-modal-label" for="input-modal-field" class="form-label"></label>
                    <input type="text" id="input-modal-field" class="form-control" required>
                    <div id="input-modal-error"
                        style="color: #ef5350; font-size: 0.8rem; margin-top: 0.5rem; display: none;"></div>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button id="input-modal-cancel-btn" class="btn btn-ghost">Annuler</button>
                <button id="input-modal-ok-btn" class="btn btn-success">Valider</button>
            </div>
        </div>
    </div>



    <!-- ... (vos autres modales et scripts) ... -->

    <!-- ============================================
         ‚öôÔ∏è MODALE DES PARAM√àTRES (NOUVELLE)
         ============================================ -->
    <div id="settings-modal" class="modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h2 class="modal-title">Param√®tres du syst√®me</h2>
                <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="report-settings-form">
                    <h3 style="color: var(--primary); margin-bottom: 20px;">Configuration des Reports</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="setting-second-fee">Frais 2√®me report (FCFA)</label>
                            <input type="number" id="setting-second-fee" class="form-control" min="0" step="500">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="setting-third-fee">Frais 3√®me report (FCFA)</label>
                            <input type="number" id="setting-third-fee" class="form-control" min="0" step="500">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="setting-max-reports">Max reports par r√©servation</label>
                            <input type="number" id="setting-max-reports" class="form-control" min="1" max="5">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="setting-min-hours">D√©lai minimum avant d√©part
                                (heures)</label>
                            <input type="number" id="setting-min-hours" class="form-control" min="1">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-4">
                        <span>üíæ</span> Enregistrer les param√®tres
                    </button>
                </form>
            </div>
        </div>
    </div>

</body> <!-- Votre balise de fermeture </body> -->

</html>

</body>

</html>